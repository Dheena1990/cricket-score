<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricket Scorer Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            -webkit-tap-highlight-color: transparent;
        }
        
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.9em;
        }

        @media (min-width: 768px) {
            .header {
                padding: 30px;
            }
            
            .header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }
            
            .header p {
                font-size: 1em;
            }
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tab {
            flex: 1;
            min-width: 100px;
            padding: 12px 10px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .nav-tab {
                padding: 15px;
                font-size: 16px;
            }
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 15px;
        }

        .tab-content.active {
            display: block;
        }

        @media (min-width: 768px) {
            .tab-content {
                padding: 30px;
            }
        }

        /* Match Setup */
        .setup-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 44px;
            touch-action: manipulation;
        }

        @media (min-width: 768px) {
            .btn {
                padding: 12px 30px;
                font-size: 16px;
            }
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }

        .btn-success:active {
            transform: scale(0.98);
        }

        .btn-danger:active {
            transform: scale(0.98);
        }

        .btn-secondary:active {
            transform: scale(0.98);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        /* Live Scoring */
        .scoreboard {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .innings-info {
            text-align: center;
            font-size: 1.1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .score-display {
            text-align: center;
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        @media (min-width: 768px) {
            .scoreboard {
                padding: 30px;
                margin-bottom: 30px;
            }
            
            .score-display {
                font-size: 3em;
                margin-bottom: 20px;
            }
        }

        .score-info {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .score-item {
            text-align: center;
            min-width: 80px;
        }

        .score-item .label {
            font-size: 0.85em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .score-item .value {
            font-size: 1.3em;
            font-weight: bold;
        }

        @media (min-width: 768px) {
            .score-info {
                gap: 20px;
            }
            
            .score-item .label {
                font-size: 0.9em;
            }
            
            .score-item .value {
                font-size: 1.5em;
            }
        }

        .current-players {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .current-players {
                gap: 20px;
                margin-bottom: 30px;
            }
        }

        .player-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .player-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .player-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.95em;
            color: #666;
        }

        @media (min-width: 768px) {
            .player-stats {
                gap: 15px;
                font-size: 1.1em;
            }
        }

        .scoring-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .score-btn {
            padding: 18px;
            font-size: 1.3em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
            min-height: 60px;
            touch-action: manipulation;
        }

        @media (min-width: 768px) {
            .scoring-buttons {
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
            }
            
            .score-btn {
                padding: 20px;
                font-size: 1.5em;
                min-height: auto;
            }
        }

        .score-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .score-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .score-btn.runs {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
        }

        .score-btn.wicket {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
            border: none;
        }

        .commentary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .commentary-item {
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .commentary-item.summary {
            background: #e8f4f8;
            border-left: 4px solid #2196F3;
            font-weight: 600;
        }

        .commentary-item.info {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        .commentary-over {
            font-weight: bold;
            color: #667eea;
        }

        /* Scorecard styles */
        .scorecard-section {
            margin-bottom: 25px;
        }

        .scorecard-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .scorecard-table thead {
            background: #f8f9fa;
        }

        .scorecard-table th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
            border-bottom: 2px solid #dee2e6;
        }

        .scorecard-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.95em;
        }

        .scorecard-table tr:hover {
            background: #f8f9fa;
        }

        .player-name-cell {
            font-weight: 600;
            color: #667eea;
        }

        .dismissal-text {
            font-size: 0.85em;
            color: #666;
            font-style: italic;
        }

        .not-out {
            color: #28a745;
            font-weight: 600;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .extras-row {
            background: #f8f9fa;
            font-weight: 600;
        }

        .total-row {
            background: #e8f4f8;
            font-weight: 700;
            font-size: 1.05em;
        }

        .fow-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .fow-item {
            padding: 8px 12px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .yet-to-bat {
            color: #666;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .scorecard-table th,
            .scorecard-table td {
                padding: 8px 4px;
                font-size: 0.85em;
            }
            
            .scorecard-table th:first-child,
            .scorecard-table td:first-child {
                padding-left: 8px;
            }
        }

        /* Match History */
        .match-list {
            display: grid;
            gap: 20px;
        }

        .match-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .match-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .match-header {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }

        @media (min-width: 768px) {
            .match-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .match-teams {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        @media (min-width: 768px) {
            .match-teams {
                font-size: 1.2em;
            }
        }

        .match-date {
            color: #666;
            font-size: 0.9em;
        }

        .match-score {
            font-size: 1.1em;
            color: #667eea;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow-y: auto;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 20px;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            width: 100%;
            margin: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            animation: slideUp 0.3s ease;
        }

        @media (min-width: 768px) {
            .modal {
                padding: 20px;
            }
            
            .modal-content {
                padding: 30px;
                max-height: 80vh;
                width: 90%;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h2 {
            color: #333;
            font-size: 1.5em;
            margin: 0;
        }

        .close-modal {
            font-size: 2em;
            cursor: pointer;
            color: #999;
            transition: all 0.2s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-modal:hover {
            color: #dc3545;
            background: #ffe5e5;
        }

        /* Dismissal buttons */
        .dismissal-btn {
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 12px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #333;
        }

        .dismissal-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .dismissal-icon {
            font-size: 1.5em;
        }

        /* Custom alert styles */
        .alert-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .alert-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .alert-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        /* End of innings celebration */
        .innings-complete {
            text-align: center;
            padding: 30px;
        }

        .innings-complete .trophy {
            font-size: 5em;
            margin-bottom: 20px;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .score-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.3em;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .target-box {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(245, 87, 108, 0.3);
        }

        .target-box h3 {
            margin: 0 0 10px 0;
            font-size: 1.4em;
        }

        .target-box .target-score {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .player-list {
            display: grid;
            gap: 10px;
            margin-top: 20px;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 5px;
            gap: 10px;
        }

        .player-item span {
            flex: 1;
            font-size: 1em;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .player-roster-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-roster-info {
            flex: 1;
        }

        .player-roster-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .player-roster-stats {
            display: flex;
            gap: 20px;
            color: #666;
            font-size: 0.9em;
        }

        .player-roster-actions {
            display: flex;
            gap: 10px;
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #667eea;
            margin-right: 15px;
        }

        .player-avatar-placeholder {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            margin-right: 15px;
        }

        .player-roster-card {
            display: flex;
            align-items: center;
        }

        @media (max-width: 768px) {
            .player-roster-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .player-roster-actions {
                width: 100%;
            }

            .player-roster-actions button {
                flex: 1;
            }

            .current-players {
                grid-template-columns: 1fr;
            }

            .player-card {
                padding: 15px;
            }

            .commentary {
                max-height: 200px;
                font-size: 0.9em;
            }

            .match-card {
                padding: 15px;
            }

            .match-teams {
                font-size: 1em;
            }

            h2 {
                font-size: 1.5em;
            }

            h3 {
                font-size: 1.2em;
            }
        }

        @media (min-width: 769px) {
            .current-players {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèè Cricket Scorer Pro</h1>
            <p>Professional Cricket Scoring for Your Team</p>
        </div>

        <!-- Save Indicator -->
        <div id="saveIndicator" style="position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 10px 20px; border-radius: 25px; font-size: 0.9em; font-weight: 600; opacity: 0; transition: opacity 0.3s; z-index: 999; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            ‚úì Saved
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('setup')">New Match</button>
            <button class="nav-tab" onclick="switchTab('live')" id="liveTab">Live Scoring</button>
            <button class="nav-tab" onclick="switchTab('players')">Players</button>
            <button class="nav-tab" onclick="switchTab('history')">Match History</button>
        </div>

        <!-- Setup Tab -->
        <div id="setup" class="tab-content active">
            <div class="setup-form">
                <h2 style="margin-bottom: 30px; text-align: center; color: #333;">Start New Match</h2>
                
                <div class="form-group">
                    <label>Team 1 Name</label>
                    <input type="text" id="team1Name" placeholder="Enter Team 1 name">
                </div>

                <div class="form-group">
                    <label>Team 2 Name</label>
                    <input type="text" id="team2Name" placeholder="Enter Team 2 name">
                </div>

                <div class="form-group">
                    <label>Overs Per Innings</label>
                    <input type="number" id="totalOvers" value="20" min="1" max="50">
                </div>

                <div class="form-group">
                    <label>Match Date</label>
                    <input type="date" id="matchDate">
                </div>

                <div class="form-group">
                    <label>Toss Winner</label>
                    <select id="tossWinner">
                        <option value="">Select toss winner</option>
                        <option value="team1">Team 1</option>
                        <option value="team2">Team 2</option>
                    </select>
                </div>

                <div class="form-group" id="tossDecisionGroup" style="display: none;">
                    <label>Toss Decision</label>
                    <select id="tossDecision">
                        <option value="bat">Choose to Bat</option>
                        <option value="bowl">Choose to Bowl</option>
                    </select>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="startMatch()">Start Match</button>
                </div>
            </div>
        </div>

        <!-- Live Scoring Tab -->
        <div id="live" class="tab-content">
            <div id="noMatchMessage" class="empty-state">
                <div style="font-size: 4em; margin-bottom: 20px;">üèè</div>
                <h2>No Active Match</h2>
                <p>Start a new match to begin scoring</p>
            </div>

            <div id="scoringInterface" style="display: none;">
                <!-- Sub-navigation for live scoring -->
                <div style="display: flex; background: #f8f9fa; border-bottom: 2px solid #dee2e6; margin-bottom: 20px;">
                    <button class="scoring-sub-tab active" onclick="switchScoringTab('live')" id="liveSubTab" style="flex: 1; padding: 12px; border: none; background: white; font-weight: 600; border-bottom: 3px solid #667eea; cursor: pointer;">Live</button>
                    <button class="scoring-sub-tab" onclick="switchScoringTab('scorecard')" id="scorecardSubTab" style="flex: 1; padding: 12px; border: none; background: #f8f9fa; font-weight: 600; cursor: pointer;">Scorecard</button>
                </div>

                <!-- Live Scoring View -->
                <div id="liveView" class="scoring-view active">
                <div class="scoreboard">
                    <div style="text-align: center; margin-bottom: 10px; font-size: 0.9em; opacity: 0.9;">
                        <span id="inningsDisplay">Innings 1</span> ‚Ä¢ <span id="battingTeamDisplay"></span> Batting
                    </div>
                    <div class="score-display" id="scoreDisplay">0/0</div>
                    <div class="score-info">
                        <div class="score-item">
                            <div class="label">Overs</div>
                            <div class="value" id="oversDisplay">0.0</div>
                        </div>
                        <div class="score-item">
                            <div class="label">Run Rate</div>
                            <div class="value" id="runRateDisplay">0.00</div>
                        </div>
                        <div class="score-item">
                            <div class="label">Target</div>
                            <div class="value" id="targetDisplay">-</div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px; font-size: 1.1em;" id="currentBatsmenHeading">
                    Current Batsmen
                </h3>
                <div class="current-players" id="currentBatsmen"></div>

                <h3 style="margin-bottom: 15px; font-size: 1.1em;">Current Bowler</h3>
                <div class="current-players" id="currentBowler"></div>

                <h3 style="margin-bottom: 15px; font-size: 1.1em;">Scoring</h3>
                <div class="scoring-buttons">
                    <button class="score-btn runs" onclick="addRuns(0)">0</button>
                    <button class="score-btn runs" onclick="addRuns(1)">1</button>
                    <button class="score-btn runs" onclick="addRuns(2)">2</button>
                    <button class="score-btn runs" onclick="addRuns(3)">3</button>
                    <button class="score-btn runs" onclick="addRuns(4)">4</button>
                    <button class="score-btn runs" onclick="addRuns(6)">6</button>
                    <button class="score-btn" onclick="showExtrasModal('wide')">WD</button>
                    <button class="score-btn" onclick="showExtrasModal('noball')">NB</button>
                    <button class="score-btn" onclick="showExtrasModal('bye')">B</button>
                    <button class="score-btn" onclick="showExtrasModal('legbye')">LB</button>
                    <button class="score-btn wicket" onclick="addWicket()">OUT</button>
                    <button class="score-btn btn-secondary" onclick="undoLast()">UNDO</button>
                </div>

                <div style="margin: 20px 0; display: grid; gap: 10px; grid-template-columns: 1fr 1fr;">
                    <button class="btn btn-success" onclick="openPlayerModal('batsman')">Change Batsman</button>
                    <button class="btn btn-success" onclick="openPlayerModal('bowler')">Change Bowler</button>
                    <button class="btn btn-secondary" onclick="retireBatsman()">Retire Batsman</button>
                    <button class="btn btn-secondary" onclick="endInnings()">End Innings</button>
                    <button class="btn btn-danger" onclick="endMatch()">End Match</button>
                </div>

                <h3 style="margin-bottom: 15px; font-size: 1.1em;">Ball-by-Ball Commentary</h3>
                <div class="commentary" id="commentary"></div>
                </div>
                <!-- End of Live View -->

                <!-- Scorecard View -->
                <div id="scorecardView" class="scoring-view" style="display: none;">
                    <div id="fullScorecard"></div>
                </div>
                <!-- End of Scorecard View -->
            </div>
        </div>

        <!-- Players Tab -->
        <div id="players" class="tab-content">
            <h2 style="margin-bottom: 30px; text-align: center; color: #333;">Player Management</h2>
            
            <div class="setup-form">
                <div class="form-group">
                    <label>Player Name</label>
                    <input type="text" id="newPlayerName" placeholder="Enter player name">
                </div>
                <div class="form-group">
                    <label>Team</label>
                    <select id="newPlayerTeam">
                        <option value="">Select Team</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Profile Picture (Optional)</label>
                    <input type="file" id="playerProfilePic" accept="image/*" style="padding: 8px;">
                    <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Max size: 500KB. Square images work best.</p>
                </div>
                <div style="text-align: center; margin-bottom: 40px;">
                    <button class="btn btn-primary" onclick="addPlayerToRoster()">Add Player</button>
                </div>
            </div>

            <h3 style="margin-bottom: 20px; text-align: center;">Player Roster</h3>
            <div id="playerRoster" class="match-list"></div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <h2 style="margin-bottom: 30px; text-align: center; color: #333;">Match History</h2>
            <div id="matchHistory" class="match-list"></div>
        </div>
    </div>

    <!-- Player Selection Modal -->
    <div id="playerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Select Player</h2>
                <span class="close-modal" onclick="closePlayerModal()">&times;</span>
            </div>
            
            <div id="strikeSelection" style="display: none; margin-bottom: 20px; padding: 15px; background: #e8f4f8; border-radius: 8px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                    Who will be on strike? (Facing the bowler)
                </label>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="setStrikePreference('strike')" id="strikeBtn" style="flex: 1;">
                        On Strike ‚ö°
                    </button>
                    <button class="btn btn-secondary" onclick="setStrikePreference('nonstrike')" id="nonStrikeBtn" style="flex: 1;">
                        Non-Strike
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Player Name</label>
                <input type="text" id="playerNameInput" placeholder="Enter player name">
                <button class="btn btn-primary" style="margin-top: 10px; width: 100%;" onclick="addNewPlayer()">Add Player</button>
            </div>
            <div class="player-list" id="playerList"></div>
        </div>
    </div>

    <!-- Match Details Modal -->
    <div id="matchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Match Details</h2>
                <span class="close-modal" onclick="closeMatchModal()">&times;</span>
            </div>
            <div id="matchDetails"></div>
        </div>
    </div>

    <!-- Dismissal Modal -->
    <div id="dismissalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Wicket - How Out?</h2>
                <span class="close-modal" onclick="closeDismissalModal()">&times;</span>
            </div>
            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border-radius: 15px; margin-bottom: 25px;">
                <div style="font-size: 3em; margin-bottom: 10px;">üèè</div>
                <h3 style="color: white; margin: 0; font-size: 1.3em;" id="dismissedPlayerName"></h3>
                <p style="color: rgba(255,255,255,0.9); margin: 5px 0 0 0;">is OUT!</p>
            </div>
            
            <p style="margin-bottom: 20px; color: #666; font-weight: 600;">
                Select dismissal type:
            </p>
            
            <div style="display: grid; gap: 12px; margin-bottom: 20px;">
                <button class="dismissal-btn" onclick="selectDismissal('bowled')">
                    <span class="dismissal-icon">üéØ</span> Bowled
                </button>
                <button class="dismissal-btn" onclick="selectDismissal('caught')">
                    <span class="dismissal-icon">üôå</span> Caught
                </button>
                <button class="dismissal-btn" onclick="selectDismissal('lbw')">
                    <span class="dismissal-icon">ü¶µ</span> LBW
                </button>
                <button class="dismissal-btn" onclick="selectDismissal('stumped')">
                    <span class="dismissal-icon">‚ö°</span> Stumped
                </button>
                <button class="dismissal-btn" onclick="selectDismissal('runout')">
                    <span class="dismissal-icon">üèÉ</span> Run Out
                </button>
                <button class="dismissal-btn" onclick="selectDismissal('hitwicket')">
                    <span class="dismissal-icon">üí•</span> Hit Wicket
                </button>
            </div>
            
            <div id="fielderSelection" style="display: none; margin-top: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Fielder Involved:</label>
                <select id="fielderSelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px;">
                    <option value="">Select fielder</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div style="text-align: center;">
                <div id="alertIcon" style="font-size: 4em; margin-bottom: 15px;">‚ÑπÔ∏è</div>
                <h2 id="alertTitle" style="margin-bottom: 15px; color: #333;"></h2>
                <p id="alertMessage" style="color: #666; line-height: 1.6; white-space: pre-line; margin-bottom: 25px;"></p>
                <button class="btn btn-primary" onclick="closeCustomAlert()" style="width: 100%; padding: 15px; font-size: 1.1em;">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Extras Modal -->
    <div id="extrasModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="extrasTitle">Extra Runs</h2>
                <span class="close-modal" onclick="closeExtrasModal()">&times;</span>
            </div>
            <p id="extrasDescription" style="margin-bottom: 20px; color: #666;"></p>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <button class="btn btn-primary" onclick="confirmExtra(0)">0</button>
                <button class="btn btn-primary" onclick="confirmExtra(1)">1</button>
                <button class="btn btn-primary" onclick="confirmExtra(2)">2</button>
                <button class="btn btn-primary" onclick="confirmExtra(3)">3</button>
                <button class="btn btn-primary" onclick="confirmExtra(4)">4</button>
                <button class="btn btn-primary" onclick="confirmExtra(6)">6</button>
            </div>
        </div>
    </div>

    <script>
        let currentMatch = null;
        let matchHistory = [];
        let players = []; // Array of {name, team} objects
        let playerStats = {}; // Track career statistics for each player
        let currentPlayerType = '';
        let allTeams = new Set(); // Track all team names
        let pendingDismissal = null; // Track dismissal being processed
        let dismissedBatsmen = []; // Track who is already out in current innings
        let strikePreference = 'strike'; // 'strike' or 'nonstrike' - where new batsman should go
        let currentExtraType = '';

        // Initialize
        async function init() {
            try {
                const dateInput = document.getElementById('matchDate');
                dateInput.valueAsDate = new Date();

                // Load match history
                const historyData = await window.storage.get('matchHistory', true);
                if (historyData) {
                    matchHistory = JSON.parse(historyData.value);
                    // Extract unique team names from match history
                    matchHistory.forEach(match => {
                        if (match.team1) allTeams.add(match.team1);
                        if (match.team2) allTeams.add(match.team2);
                    });
                    displayMatchHistory();
                }

                // Load current match
                const currentData = await window.storage.get('currentMatch', false);
                if (currentData) {
                    currentMatch = JSON.parse(currentData.value);
                    if (currentMatch.team1) allTeams.add(currentMatch.team1);
                    if (currentMatch.team2) allTeams.add(currentMatch.team2);
                    
                    // Restore dismissed batsmen list from ball history
                    if (currentMatch && currentMatch.ballHistory) {
                        dismissedBatsmen = [];
                        currentMatch.ballHistory.forEach(ball => {
                            if (ball.type === 'wicket' && ball.striker) {
                                if (!dismissedBatsmen.includes(ball.striker.name)) {
                                    dismissedBatsmen.push(ball.striker.name);
                                }
                            }
                        });
                    }
                    
                    document.getElementById('liveTab').click();
                    displayLiveMatch();
                    
                    // Show restoration message
                    setTimeout(() => {
                        showCustomAlert(
                            'Match Restored! ‚úÖ', 
                            `Your match has been restored:\n\n${currentMatch.team1} vs ${currentMatch.team2}\nInnings ${currentMatch.innings}\nScore: ${currentMatch.score}/${currentMatch.wickets}`, 
                            'üèè', 
                            'success'
                        );
                    }, 500);
                }

                // Load players
                const playersData = await window.storage.get('players', true);
                if (playersData) {
                    players = JSON.parse(playersData.value);
                    // For backwards compatibility, convert old string array to object array
                    if (players.length > 0 && typeof players[0] === 'string') {
                        players = players.map(name => ({name, team: 'Unknown'}));
                    }
                }

                // Load player stats
                const statsData = await window.storage.get('playerStats', true);
                if (statsData) {
                    playerStats = JSON.parse(statsData.value);
                }

                // Load teams
                const teamsData = await window.storage.get('allTeams', true);
                if (teamsData) {
                    const teamsArray = JSON.parse(teamsData.value);
                    allTeams = new Set(teamsArray);
                }

                updateTeamDropdown();
                displayPlayerRoster();
            } catch (error) {
                console.log('Initializing fresh state');
            }

            // Add event listener for toss winner selection
            document.getElementById('tossWinner').addEventListener('change', function() {
                const tossDecisionGroup = document.getElementById('tossDecisionGroup');
                if (this.value) {
                    tossDecisionGroup.style.display = 'block';
                } else {
                    tossDecisionGroup.style.display = 'none';
                }
            });

            // Update toss winner options when team names change
            document.getElementById('team1Name').addEventListener('input', updateTossOptions);
            document.getElementById('team2Name').addEventListener('input', updateTossOptions);

            // Prevent accidental page refresh/close during active match
            window.addEventListener('beforeunload', function(e) {
                if (currentMatch && currentMatch.score >= 0) {
                    // Show browser warning
                    e.preventDefault();
                    e.returnValue = 'You have an active cricket match. Are you sure you want to leave? Your progress is automatically saved.';
                    return e.returnValue;
                }
            });

            // Auto-save every 30 seconds as backup
            setInterval(() => {
                if (currentMatch) {
                    saveCurrentMatch();
                    console.log('Auto-saved match at', new Date().toLocaleTimeString());
                }
            }, 30000);
        }

        function updateTossOptions() {
            const team1 = document.getElementById('team1Name').value.trim();
            const team2 = document.getElementById('team2Name').value.trim();
            const tossWinner = document.getElementById('tossWinner');
            const currentValue = tossWinner.value;

            tossWinner.innerHTML = '<option value="">Select toss winner</option>';
            
            if (team1) {
                const option1 = document.createElement('option');
                option1.value = 'team1';
                option1.textContent = team1;
                tossWinner.appendChild(option1);
            }
            
            if (team2) {
                const option2 = document.createElement('option');
                option2.value = 'team2';
                option2.textContent = team2;
                tossWinner.appendChild(option2);
            }

            // Restore selection if still valid
            if (currentValue) {
                tossWinner.value = currentValue;
            }
        }

        async function saveCurrentMatch() {
            try {
                await window.storage.set('currentMatch', JSON.stringify(currentMatch), false);
                showSaveIndicator();
            } catch (error) {
                console.error('Error saving match:', error);
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            if (indicator) {
                indicator.style.opacity = '1';
                setTimeout(() => {
                    indicator.style.opacity = '0';
                }, 1500);
            }
        }

        async function savePlayers() {
            try {
                await window.storage.set('players', JSON.stringify(players), true);
            } catch (error) {
                console.error('Error saving players:', error);
            }
        }

        async function savePlayerStats() {
            try {
                await window.storage.set('playerStats', JSON.stringify(playerStats), true);
            } catch (error) {
                console.error('Error saving player stats:', error);
            }
        }

        async function saveTeams() {
            try {
                await window.storage.set('allTeams', JSON.stringify([...allTeams]), true);
            } catch (error) {
                console.error('Error saving teams:', error);
            }
        }

        function updateTeamDropdown() {
            const dropdown = document.getElementById('newPlayerTeam');
            dropdown.innerHTML = '<option value="">Select Team</option>';
            
            [...allTeams].sort().forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                dropdown.appendChild(option);
            });
        }

        async function saveMatchHistory() {
            try {
                await window.storage.set('matchHistory', JSON.stringify(matchHistory), true);
            } catch (error) {
                console.error('Error saving history:', error);
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'history') {
                displayMatchHistory();
            } else if (tabName === 'players') {
                displayPlayerRoster();
            }
        }

        function startMatch() {
            const team1 = document.getElementById('team1Name').value.trim();
            const team2 = document.getElementById('team2Name').value.trim();
            const overs = parseInt(document.getElementById('totalOvers').value);
            const date = document.getElementById('matchDate').value;
            const tossWinner = document.getElementById('tossWinner').value;
            const tossDecision = document.getElementById('tossDecision').value;

            if (!team1 || !team2) {
                showCustomAlert('Missing Information', 'Please enter both team names', '‚ö†Ô∏è', 'warning');
                return;
            }

            if (!tossWinner) {
                showCustomAlert('Toss Required', 'Please select the toss winner before starting the match', 'ü™ô', 'warning');
                return;
            }

            // Determine batting and bowling teams based on toss
            let battingTeam, bowlingTeam, tossWinnerName;
            
            if (tossWinner === 'team1') {
                tossWinnerName = team1;
                if (tossDecision === 'bat') {
                    battingTeam = team1;
                    bowlingTeam = team2;
                } else {
                    battingTeam = team2;
                    bowlingTeam = team1;
                }
            } else {
                tossWinnerName = team2;
                if (tossDecision === 'bat') {
                    battingTeam = team2;
                    bowlingTeam = team1;
                } else {
                    battingTeam = team1;
                    bowlingTeam = team2;
                }
            }

            // Add teams to the global teams set
            allTeams.add(team1);
            allTeams.add(team2);
            saveTeams();
            updateTeamDropdown();

            currentMatch = {
                id: Date.now(),
                team1: team1,
                team2: team2,
                totalOvers: overs,
                date: date,
                innings: 1,
                batting: battingTeam,
                bowling: bowlingTeam,
                tossWinner: tossWinnerName,
                tossDecision: tossDecision,
                score: 0,
                wickets: 0,
                overs: 0,
                balls: 0,
                innings1Score: null,
                innings2Score: null,
                striker: null,
                nonStriker: null,
                bowler: null,
                commentary: [],
                ballHistory: []
            };

            currentMatch.commentary.push({
                over: 'Toss',
                text: `${tossWinnerName} won the toss and chose to ${tossDecision === 'bat' ? 'bat' : 'bowl'} first`
            });

            dismissedBatsmen = []; // Reset dismissed batsmen list

            saveCurrentMatch();
            document.getElementById('liveTab').click();
            displayLiveMatch();
        }

        function displayLiveMatch() {
            if (!currentMatch) {
                document.getElementById('noMatchMessage').style.display = 'block';
                document.getElementById('scoringInterface').style.display = 'none';
                return;
            }

            document.getElementById('noMatchMessage').style.display = 'none';
            document.getElementById('scoringInterface').style.display = 'block';

            updateScoreboard();
            updateCurrentPlayers();
            updateCommentary();
            updateFullScorecard();
        }

        function switchScoringTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.scoring-sub-tab').forEach(tab => {
                tab.style.background = '#f8f9fa';
                tab.style.borderBottom = 'none';
            });

            if (tabName === 'live') {
                document.getElementById('liveSubTab').style.background = 'white';
                document.getElementById('liveSubTab').style.borderBottom = '3px solid #667eea';
                document.getElementById('liveView').style.display = 'block';
                document.getElementById('scorecardView').style.display = 'none';
            } else if (tabName === 'scorecard') {
                document.getElementById('scorecardSubTab').style.background = 'white';
                document.getElementById('scorecardSubTab').style.borderBottom = '3px solid #667eea';
                document.getElementById('liveView').style.display = 'none';
                document.getElementById('scorecardView').style.display = 'block';
                updateFullScorecard();
            }
        }

        function updateScoreboard() {
            // Update innings and batting team display
            document.getElementById('inningsDisplay').textContent = `Innings ${currentMatch.innings}`;
            document.getElementById('battingTeamDisplay').textContent = currentMatch.batting;
            
            document.getElementById('scoreDisplay').textContent = 
                `${currentMatch.score}/${currentMatch.wickets}`;
            
            const oversComplete = Math.floor(currentMatch.balls / 6);
            const ballsInOver = currentMatch.balls % 6;
            document.getElementById('oversDisplay').textContent = 
                `${oversComplete}.${ballsInOver}`;

            const runRate = currentMatch.balls > 0 ? 
                (currentMatch.score / (currentMatch.balls / 6)).toFixed(2) : '0.00';
            document.getElementById('runRateDisplay').textContent = runRate;

            let targetText = '-';
            if (currentMatch.innings === 2 && currentMatch.innings1Score) {
                const target = currentMatch.innings1Score.score + 1;
                const required = target - currentMatch.score;
                const ballsLeft = (currentMatch.totalOvers * 6) - currentMatch.balls;
                const reqRate = ballsLeft > 0 ? (required / (ballsLeft / 6)).toFixed(2) : '0.00';
                targetText = `${required} runs (RR: ${reqRate})`;
            }
            document.getElementById('targetDisplay').textContent = targetText;
        }

        function updateCurrentPlayers() {
            // Update heading with swap button if both batsmen present
            const heading = document.getElementById('currentBatsmenHeading');
            if (currentMatch.striker && currentMatch.nonStriker) {
                heading.innerHTML = `
                    Current Batsmen
                    <button class="btn btn-secondary" onclick="swapStrike()" style="float: right; padding: 8px 15px; font-size: 0.9em;">‚áÑ Swap Strike</button>
                `;
            } else {
                heading.innerHTML = 'Current Batsmen';
            }

            const batsmenDiv = document.getElementById('currentBatsmen');
            batsmenDiv.innerHTML = '';

            if (currentMatch.striker) {
                batsmenDiv.innerHTML += createPlayerCard(currentMatch.striker, true);
            }
            if (currentMatch.nonStriker) {
                batsmenDiv.innerHTML += createPlayerCard(currentMatch.nonStriker, false);
            }

            const bowlerDiv = document.getElementById('currentBowler');
            bowlerDiv.innerHTML = '';
            if (currentMatch.bowler) {
                bowlerDiv.innerHTML = createBowlerCard(currentMatch.bowler);
            }
        }

        function createPlayerCard(player, isStriker) {
            const strikerMark = isStriker ? ' *' : '';
            return `
                <div class="player-card">
                    <h3>${player.name}${strikerMark}</h3>
                    <div class="player-stats">
                        <span>${player.runs} runs</span>
                        <span>${player.balls} balls</span>
                        <span>SR: ${player.balls > 0 ? ((player.runs / player.balls) * 100).toFixed(1) : '0.0'}</span>
                    </div>
                </div>
            `;
        }

        function createBowlerCard(bowler) {
            const overs = Math.floor(bowler.balls / 6);
            const balls = bowler.balls % 6;
            return `
                <div class="player-card">
                    <h3>${bowler.name}</h3>
                    <div class="player-stats">
                        <span>${overs}.${balls} overs</span>
                        <span>${bowler.runs} runs</span>
                        <span>${bowler.wickets} wickets</span>
                        <span>Econ: ${bowler.balls > 0 ? ((bowler.runs / (bowler.balls / 6)).toFixed(2)) : '0.00'}</span>
                    </div>
                </div>
            `;
        }

        function updateCommentary() {
            const commentaryDiv = document.getElementById('commentary');
            commentaryDiv.innerHTML = '';
            
            const recent = currentMatch.commentary.slice(-20).reverse();
            recent.forEach(item => {
                let itemClass = '';
                if (item.type === 'summary') itemClass = ' summary';
                if (item.type === 'info') itemClass = ' info';
                
                commentaryDiv.innerHTML += `
                    <div class="commentary-item${itemClass}">
                        <span class="commentary-over">${item.over}</span>: ${item.text}
                    </div>
                `;
            });
        }

        function updateFullScorecard() {
            const scorecardDiv = document.getElementById('fullScorecard');
            if (!currentMatch) return;

            // Collect all batsmen who have batted or are batting
            const allBatsmen = [];
            const battedPlayers = new Set();
            const bowledPlayers = new Map(); // Map of bowler name to stats

            // Process ball history to get all players and their final stats
            currentMatch.ballHistory.forEach(ball => {
                if (ball.striker && ball.striker.name && !battedPlayers.has(ball.striker.name)) {
                    battedPlayers.add(ball.striker.name);
                }
                
                // Track bowlers
                if (ball.bowler && ball.bowler.name) {
                    if (!bowledPlayers.has(ball.bowler.name)) {
                        bowledPlayers.set(ball.bowler.name, {
                            name: ball.bowler.name,
                            overs: 0,
                            maidens: 0,
                            runs: 0,
                            wickets: 0,
                            balls: 0
                        });
                    }
                }
            });

            // Add current batsmen
            if (currentMatch.striker) {
                allBatsmen.push({
                    ...currentMatch.striker,
                    dismissal: 'not out',
                    current: true
                });
                battedPlayers.add(currentMatch.striker.name);
            }

            if (currentMatch.nonStriker) {
                allBatsmen.push({
                    ...currentMatch.nonStriker,
                    dismissal: 'not out',
                    current: true
                });
                battedPlayers.add(currentMatch.nonStriker.name);
            }

            // Get dismissed batsmen from ball history
            currentMatch.ballHistory.forEach((ball, index) => {
                if (ball.type === 'wicket' && ball.striker) {
                    const existing = allBatsmen.find(b => b.name === ball.striker.name);
                    const dismissalText = ball.dismissalText || `c & b ${ball.bowler ? ball.bowler.name : 'bowler'}`;
                    
                    if (!existing) {
                        allBatsmen.push({
                            name: ball.striker.name,
                            runs: ball.striker.runs,
                            balls: ball.striker.balls,
                            dismissal: dismissalText,
                            current: false
                        });
                    } else if (existing.current) {
                        existing.dismissal = dismissalText;
                        existing.current = false;
                    }
                }
            });

            // Calculate bowling figures
            currentMatch.ballHistory.forEach(ball => {
                if (ball.bowler && ball.bowler.name) {
                    const bowlerStats = bowledPlayers.get(ball.bowler.name);
                    if (bowlerStats) {
                        if (ball.type === 'runs' || (ball.type === 'extra' && ball.isLegalDelivery)) {
                            bowlerStats.balls++;
                            bowlerStats.runs += (ball.type === 'runs' ? ball.runs : (ball.extraType === 'bye' || ball.extraType === 'legbye' ? 0 : ball.runs));
                        }
                        if (ball.type === 'wicket') {
                            bowlerStats.wickets++;
                        }
                        if (ball.type === 'extra' && !ball.isLegalDelivery) {
                            bowlerStats.runs += ball.runs;
                        }
                    }
                }
            });

            // Add current bowler
            if (currentMatch.bowler) {
                const bowlerStats = bowledPlayers.get(currentMatch.bowler.name);
                if (bowlerStats) {
                    bowlerStats.balls = currentMatch.bowler.balls;
                    bowlerStats.runs = currentMatch.bowler.runs;
                    bowlerStats.wickets = currentMatch.bowler.wickets;
                }
            }

            // Convert to arrays and sort
            const bowlers = Array.from(bowledPlayers.values())
                .filter(b => b.balls > 0)
                .map(b => ({
                    ...b,
                    overs: Math.floor(b.balls / 6) + (b.balls % 6) / 10
                }));

            // Fall of wickets
            const fallOfWickets = [];
            let wicketCounter = 0;
            currentMatch.ballHistory.forEach(ball => {
                if (ball.type === 'wicket') {
                    wicketCounter++;
                    const overNum = Math.floor((ball.balls - 1) / 6) + ((ball.balls - 1) % 6 + 1) / 10;
                    fallOfWickets.push({
                        wicket: wicketCounter,
                        player: ball.striker.name,
                        score: ball.score,
                        over: overNum.toFixed(1)
                    });
                }
            });

            // Get team players for "yet to bat"
            const battingTeamPlayers = players.filter(p => p.team === currentMatch.batting);
            const yetToBat = battingTeamPlayers.filter(p => !battedPlayers.has(p.name)).map(p => p.name);

            // Build HTML
            let html = `
                <div class="scorecard-section">
                    <h3 class="section-title">${currentMatch.batting} Innings</h3>
                    
                    <table class="scorecard-table">
                        <thead>
                            <tr>
                                <th>Batters</th>
                                <th style="text-align: center;">R</th>
                                <th style="text-align: center;">B</th>
                                <th style="text-align: center;">4s</th>
                                <th style="text-align: center;">6s</th>
                                <th style="text-align: center;">SR</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Add batsmen rows
            allBatsmen.forEach(batsman => {
                const fours = currentMatch.ballHistory.filter(b => 
                    b.type === 'runs' && b.runs === 4 && b.striker && b.striker.name === batsman.name
                ).length;
                const sixes = currentMatch.ballHistory.filter(b => 
                    b.type === 'runs' && b.runs === 6 && b.striker && b.striker.name === batsman.name
                ).length;
                const sr = batsman.balls > 0 ? ((batsman.runs / batsman.balls) * 100).toFixed(2) : '0.00';
                const notOutMark = batsman.current ? '*' : '';

                html += `
                    <tr>
                        <td class="player-name-cell">
                            ${batsman.name}${notOutMark}
                            <div class="dismissal-text">${batsman.dismissal}</div>
                        </td>
                        <td style="text-align: center; font-weight: 600;">${batsman.runs}</td>
                        <td style="text-align: center;">${batsman.balls}</td>
                        <td style="text-align: center;">${fours}</td>
                        <td style="text-align: center;">${sixes}</td>
                        <td style="text-align: center;">${sr}</td>
                    </tr>
                `;
            });

            // Extras
            html += `
                <tr class="extras-row">
                    <td>Extras</td>
                    <td style="text-align: center;" colspan="5">1 (wd 1)</td>
                </tr>
                <tr class="total-row">
                    <td>Total</td>
                    <td style="text-align: center;" colspan="5">${currentMatch.score}/${currentMatch.wickets} (${(currentMatch.balls / 6).toFixed(1)} Ov)</td>
                </tr>
            `;

            if (yetToBat.length > 0) {
                html += `
                    <tr>
                        <td colspan="6" class="yet-to-bat">
                            <strong>Yet to bat:</strong> ${yetToBat.join(', ')}
                        </td>
                    </tr>
                `;
            }

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            // Bowlers section
            if (bowlers.length > 0) {
                html += `
                    <div class="scorecard-section">
                        <h3 class="section-title">Bowlers</h3>
                        
                        <table class="scorecard-table">
                            <thead>
                                <tr>
                                    <th>Bowler</th>
                                    <th style="text-align: center;">O</th>
                                    <th style="text-align: center;">M</th>
                                    <th style="text-align: center;">R</th>
                                    <th style="text-align: center;">W</th>
                                    <th style="text-align: center;">Eco</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                bowlers.forEach(bowler => {
                    const economy = bowler.balls > 0 ? ((bowler.runs / (bowler.balls / 6)).toFixed(2)) : '0.00';
                    html += `
                        <tr>
                            <td class="player-name-cell">${bowler.name}</td>
                            <td style="text-align: center;">${bowler.overs.toFixed(1)}</td>
                            <td style="text-align: center;">${bowler.maidens}</td>
                            <td style="text-align: center;">${bowler.runs}</td>
                            <td style="text-align: center; font-weight: 600;">${bowler.wickets}</td>
                            <td style="text-align: center;">${economy}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Fall of wickets
            if (fallOfWickets.length > 0) {
                html += `
                    <div class="scorecard-section">
                        <h3 class="section-title">Fall of Wickets</h3>
                        <div class="fow-list">
                `;

                fallOfWickets.forEach(fow => {
                    html += `
                        <div class="fow-item">
                            <strong>${fow.wicket}</strong> - ${fow.player}<br>
                            <span style="color: #666; font-size: 0.9em;">${fow.score} (${fow.over} Ov)</span>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            scorecardDiv.innerHTML = html;
        }

        function addRuns(runs) {
            if (!currentMatch.striker || !currentMatch.bowler) {
                showCustomAlert('Players Missing', 'Please select batsmen and bowler first', 'üë•', 'warning');
                return;
            }

            currentMatch.score += runs;
            currentMatch.striker.runs += runs;
            currentMatch.striker.balls++;
            currentMatch.bowler.runs += runs;
            currentMatch.bowler.balls++;
            currentMatch.balls++;

            const oversComplete = Math.floor((currentMatch.balls - 1) / 6);
            const ballInOver = ((currentMatch.balls - 1) % 6) + 1;
            const overText = `${oversComplete}.${ballInOver}`;

            let runsText = runs === 0 ? 'dot ball' : `${runs} run${runs !== 1 ? 's' : ''}`;
            currentMatch.commentary.push({
                over: overText,
                text: `${currentMatch.bowler.name} to ${currentMatch.striker.name}, ${runsText}`,
                type: 'ball'
            });

            currentMatch.ballHistory.push({
                type: 'runs',
                runs: runs,
                striker: {...currentMatch.striker},
                nonStriker: {...currentMatch.nonStriker},
                bowler: {...currentMatch.bowler},
                score: currentMatch.score,
                wickets: currentMatch.wickets,
                balls: currentMatch.balls
            });

            // Change strike only on odd runs (1, 3, 5)
            if (runs % 2 === 1) {
                swapBatsmen();
            }

            // Check if target achieved in 2nd innings
            if (currentMatch.innings === 2 && currentMatch.innings1Score) {
                const target = currentMatch.innings1Score.score + 1;
                if (currentMatch.score >= target) {
                    saveCurrentMatch();
                    endMatch();
                    return;
                }
            }

            // Check if innings overs are complete
            if (currentMatch.balls >= currentMatch.totalOvers * 6) {
                saveCurrentMatch();
                endInnings();
                return;
            }

            checkOverComplete();
            saveCurrentMatch();
            displayLiveMatch();
        }

        function addWicket() {
            if (!currentMatch.striker || !currentMatch.bowler) {
                showCustomAlert('Players Missing', 'Please select batsmen and bowler first', 'üë•', 'warning');
                return;
            }

            // Store pending dismissal info
            pendingDismissal = {
                striker: {...currentMatch.striker},
                nonStriker: currentMatch.nonStriker ? {...currentMatch.nonStriker} : null,
                bowler: {...currentMatch.bowler},
                balls: currentMatch.balls + 1,
                score: currentMatch.score,
                wickets: currentMatch.wickets + 1
            };

            // Show player name in modal
            document.getElementById('dismissedPlayerName').textContent = currentMatch.striker.name;

            // Populate fielder dropdown with bowling team players
            const fielderSelect = document.getElementById('fielderSelect');
            fielderSelect.innerHTML = '<option value="">Select fielder</option>';
            
            const fieldingTeam = currentMatch.bowling;
            const fielders = players.filter(p => p.team === fieldingTeam);
            fielders.forEach(fielder => {
                fielderSelect.innerHTML += `<option value="${fielder.name}">${fielder.name}</option>`;
            });

            // Show dismissal modal
            document.getElementById('dismissalModal').classList.add('active');
        }

        function selectDismissal(type) {
            const fielderSelection = document.getElementById('fielderSelection');
            
            // Show fielder selection for certain dismissal types
            if (type === 'caught' || type === 'stumped' || type === 'runout') {
                fielderSelection.style.display = 'block';
                
                // Store dismissal type and wait for fielder selection
                pendingDismissal.dismissalType = type;
                
                // Add confirm button if not already there
                if (!document.getElementById('confirmDismissalBtn')) {
                    const confirmBtn = document.createElement('button');
                    confirmBtn.id = 'confirmDismissalBtn';
                    confirmBtn.className = 'btn btn-success';
                    confirmBtn.textContent = 'Confirm';
                    confirmBtn.style.width = '100%';
                    confirmBtn.style.marginTop = '15px';
                    confirmBtn.onclick = confirmDismissal;
                    fielderSelection.parentElement.appendChild(confirmBtn);
                }
            } else {
                // Process dismissal immediately for types that don't need fielder
                pendingDismissal.dismissalType = type;
                pendingDismissal.fielder = null;
                processDismissal();
            }
        }

        function confirmDismissal() {
            const fielderSelect = document.getElementById('fielderSelect');
            const fielder = fielderSelect.value;
            
            if (!fielder) {
                showCustomAlert('Fielder Required', 'Please select which fielder was involved in the dismissal', 'üôã', 'warning');
                return;
            }
            
            pendingDismissal.fielder = fielder;
            processDismissal();
        }

        function processDismissal() {
            if (!pendingDismissal) return;

            // Update match state
            currentMatch.wickets++;
            currentMatch.striker.balls++;
            currentMatch.bowler.balls++;
            currentMatch.bowler.wickets++;
            currentMatch.balls++;

            const oversComplete = Math.floor((currentMatch.balls - 1) / 6);
            const ballInOver = ((currentMatch.balls - 1) % 6) + 1;
            const overText = `${oversComplete}.${ballInOver}`;

            // Create dismissal text
            let dismissalText = '';
            const bowlerName = currentMatch.bowler.name;
            
            switch (pendingDismissal.dismissalType) {
                case 'bowled':
                    dismissalText = `b ${bowlerName}`;
                    break;
                case 'caught':
                    dismissalText = pendingDismissal.fielder === bowlerName ? 
                        `c & b ${bowlerName}` : 
                        `c ${pendingDismissal.fielder} b ${bowlerName}`;
                    break;
                case 'lbw':
                    dismissalText = `lbw b ${bowlerName}`;
                    break;
                case 'stumped':
                    dismissalText = `st ${pendingDismissal.fielder} b ${bowlerName}`;
                    break;
                case 'runout':
                    dismissalText = `run out (${pendingDismissal.fielder})`;
                    break;
                case 'hitwicket':
                    dismissalText = `hit wicket b ${bowlerName}`;
                    break;
            }

            currentMatch.commentary.push({
                over: overText,
                text: `${currentMatch.bowler.name} to ${currentMatch.striker.name}, WICKET! ${currentMatch.striker.name} ${dismissalText}`,
                type: 'ball'
            });

            currentMatch.ballHistory.push({
                type: 'wicket',
                striker: {...currentMatch.striker},
                nonStriker: {...currentMatch.nonStriker},
                bowler: {...currentMatch.bowler},
                score: currentMatch.score,
                wickets: currentMatch.wickets,
                balls: currentMatch.balls,
                dismissalType: pendingDismissal.dismissalType,
                dismissalText: dismissalText,
                fielder: pendingDismissal.fielder
            });

            // Add to dismissed batsmen list
            dismissedBatsmen.push(currentMatch.striker.name);

            // Striker gets out, so they need to be replaced
            currentMatch.striker = null;

            // Check for all out or end of innings
            if (currentMatch.wickets >= 10) {
                saveCurrentMatch();
                closeDismissalModal();
                endInnings();
                return;
            }

            // Check if innings overs are complete
            if (currentMatch.balls >= currentMatch.totalOvers * 6) {
                saveCurrentMatch();
                closeDismissalModal();
                endInnings();
                return;
            }

            checkOverComplete();
            saveCurrentMatch();
            displayLiveMatch();
            
            closeDismissalModal();
        }

        function closeDismissalModal() {
            document.getElementById('dismissalModal').classList.remove('active');
            document.getElementById('fielderSelection').style.display = 'none';
            
            // Remove confirm button if exists
            const confirmBtn = document.getElementById('confirmDismissalBtn');
            if (confirmBtn) confirmBtn.remove();
            
            pendingDismissal = null;
        }

        function showCustomAlert(title, message, icon = '‚ÑπÔ∏è', type = 'info') {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertIcon').textContent = icon;
            
            const modal = document.getElementById('customAlertModal');
            const iconDiv = document.getElementById('alertIcon');
            
            // Set color based on type
            if (type === 'success') {
                iconDiv.style.color = '#38ef7d';
            } else if (type === 'warning') {
                iconDiv.style.color = '#f5576c';
            } else {
                iconDiv.style.color = '#667eea';
            }
            
            modal.classList.add('active');
        }

        function closeCustomAlert() {
            document.getElementById('customAlertModal').classList.remove('active');
        }

        function showCustomConfirm(title, message, icon, onConfirm, onCancel) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'customConfirmModal';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div style="text-align: center;">
                        <div style="font-size: 4em; margin-bottom: 15px;">${icon}</div>
                        <h2 style="margin-bottom: 15px; color: #333;">${title}</h2>
                        <p style="color: #666; line-height: 1.6; margin-bottom: 25px;">${message}</p>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="closeCustomConfirm(false)" style="flex: 1; padding: 15px; font-size: 1.05em;">
                                Cancel
                            </button>
                            <button class="btn btn-primary" onclick="closeCustomConfirm(true)" style="flex: 1; padding: 15px; font-size: 1.05em;">
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.customConfirmCallback = { onConfirm, onCancel };
        }

        function closeCustomConfirm(confirmed) {
            const modal = document.getElementById('customConfirmModal');
            if (modal) modal.remove();
            
            if (window.customConfirmCallback) {
                if (confirmed) {
                    window.customConfirmCallback.onConfirm();
                } else {
                    window.customConfirmCallback.onCancel();
                }
                window.customConfirmCallback = null;
            }
        }

        function showInningsCompleteModal(innings1Team, innings1Score, innings2Team, target) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'inningsCompleteModal';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="innings-complete">
                        <div class="trophy">üèè</div>
                        <h2 style="color: #333; font-size: 2em; margin-bottom: 10px;">Innings Complete!</h2>
                        
                        <div class="score-highlight">
                            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">${innings1Team}</div>
                            <div style="font-size: 2em;">${innings1Score.score}/${innings1Score.wickets}</div>
                            <div style="font-size: 0.85em; opacity: 0.8; margin-top: 5px;">${innings1Score.overs.toFixed(1)} overs</div>
                        </div>
                        
                        <div class="target-box">
                            <h3>Target for ${innings2Team}</h3>
                            <div class="target-score">${target}</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">runs to win</div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="closeInningsModal()" style="width: 100%; padding: 15px; font-size: 1.1em; margin-top: 10px;">
                            Start Innings 2 üöÄ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeInningsModal() {
            const modal = document.getElementById('inningsCompleteModal');
            if (modal) modal.remove();
        }

        function retireBatsman() {
            if (!currentMatch.striker && !currentMatch.nonStriker) {
                showCustomAlert('No Batsmen', 'There are no batsmen on the field to retire', '‚ö†Ô∏è', 'warning');
                return;
            }

            // Ask which batsman to retire if both are present
            if (currentMatch.striker && currentMatch.nonStriker) {
                showCustomConfirm(
                    'Retire Batsman?',
                    `Which batsman do you want to retire?\n\nOK = ${currentMatch.striker.name}\nCancel = ${currentMatch.nonStriker.name}`,
                    'üèè',
                    () => processRetirement(currentMatch.striker),
                    () => processRetirement(currentMatch.nonStriker)
                );
            } else {
                const batsmanToRetire = currentMatch.striker || currentMatch.nonStriker;
                showCustomConfirm(
                    'Retire Batsman?',
                    `Retire ${batsmanToRetire.name}?`,
                    'üèè',
                    () => processRetirement(batsmanToRetire),
                    () => {}
                );
            }
        }

        function processRetirement(batsmanToRetire) {
            const oversComplete = Math.floor(currentMatch.balls / 6);
            const ballInOver = currentMatch.balls % 6;
            const overText = `${oversComplete}.${ballInOver}`;

            currentMatch.commentary.push({
                over: overText,
                text: `${batsmanToRetire.name} retired (${batsmanToRetire.runs} runs from ${batsmanToRetire.balls} balls)`
            });

            currentMatch.ballHistory.push({
                type: 'retired',
                batsman: {...batsmanToRetire},
                score: currentMatch.score,
                wickets: currentMatch.wickets,
                balls: currentMatch.balls
            });

            // Remove the retired batsman
            if (currentMatch.striker === batsmanToRetire) {
                currentMatch.striker = null;
            } else {
                currentMatch.nonStriker = null;
            }

            saveCurrentMatch();
            displayLiveMatch();
            
            showCustomAlert(
                'Batsman Retired',
                `${batsmanToRetire.name} has retired.\n\nSelect a new batsman to continue.`,
                'üëã',
                'info'
            );
        }

        function addExtra(type, additionalRuns = 0) {
            if (!currentMatch.bowler) {
                showCustomAlert('Bowler Missing', 'Please select a bowler before scoring extras', 'üé≥', 'warning');
                return;
            }

            if (!currentMatch.striker && (type === 'bye' || type === 'legbye')) {
                showCustomAlert('Batsmen Missing', 'Please select batsmen before scoring byes or leg byes', 'üë•', 'warning');
                return;
            }

            let runs = 0;
            let text = '';
            let isLegalDelivery = true;
            
            if (type === 'wide') {
                // Wide: 1 run penalty + any additional runs scored + doesn't count as legal delivery
                runs = 1 + additionalRuns;
                currentMatch.score += runs;
                currentMatch.bowler.runs += runs;
                text = additionalRuns > 0 ? `${runs} Wides` : 'Wide';
                isLegalDelivery = false;
            } else if (type === 'noball') {
                // No Ball: 1 run penalty + any runs scored + doesn't count as legal delivery
                runs = 1 + additionalRuns;
                currentMatch.score += runs;
                currentMatch.bowler.runs += runs;
                if (additionalRuns > 0) {
                    currentMatch.striker.runs += additionalRuns;
                }
                text = additionalRuns > 0 ? `No Ball + ${additionalRuns}` : 'No Ball';
                isLegalDelivery = false;
            } else if (type === 'bye') {
                // Bye: runs to team, counts as legal delivery, no runs to batsman or bowler
                runs = additionalRuns > 0 ? additionalRuns : 1;
                currentMatch.score += runs;
                currentMatch.striker.balls++;
                currentMatch.bowler.balls++;
                currentMatch.balls++;
                text = `${runs} Bye${runs !== 1 ? 's' : ''}`;
            } else if (type === 'legbye') {
                // Leg Bye: runs to team, counts as legal delivery, no runs to batsman or bowler
                runs = additionalRuns > 0 ? additionalRuns : 1;
                currentMatch.score += runs;
                currentMatch.striker.balls++;
                currentMatch.bowler.balls++;
                currentMatch.balls++;
                text = `${runs} Leg Bye${runs !== 1 ? 's' : ''}`;
            }

            const oversComplete = Math.floor(currentMatch.balls / 6);
            const ballInOver = currentMatch.balls % 6;
            const overText = isLegalDelivery ? 
                `${Math.floor((currentMatch.balls - 1) / 6)}.${((currentMatch.balls - 1) % 6) + 1}` :
                `${oversComplete}.${ballInOver}`;

            currentMatch.commentary.push({
                over: overText,
                text: `${currentMatch.bowler.name} to ${currentMatch.striker ? currentMatch.striker.name : 'batsman'}, ${text}`,
                type: 'ball'
            });

            currentMatch.ballHistory.push({
                type: 'extra',
                extraType: type,
                runs: runs,
                additionalRuns: additionalRuns,
                striker: currentMatch.striker ? {...currentMatch.striker} : null,
                nonStriker: currentMatch.nonStriker ? {...currentMatch.nonStriker} : null,
                bowler: {...currentMatch.bowler},
                score: currentMatch.score,
                wickets: currentMatch.wickets,
                balls: currentMatch.balls,
                isLegalDelivery: isLegalDelivery
            });

            // For byes and leg byes, change strike on odd runs
            if (isLegalDelivery && runs % 2 === 1) {
                swapBatsmen();
            }

            if (isLegalDelivery) {
                checkOverComplete();
            }

            // Check if target achieved in 2nd innings
            if (currentMatch.innings === 2 && currentMatch.innings1Score) {
                const target = currentMatch.innings1Score.score + 1;
                if (currentMatch.score >= target) {
                    saveCurrentMatch();
                    endMatch();
                    return;
                }
            }

            // Check if innings overs are complete (only for legal deliveries)
            if (isLegalDelivery && currentMatch.balls >= currentMatch.totalOvers * 6) {
                saveCurrentMatch();
                endInnings();
                return;
            }

            saveCurrentMatch();
            displayLiveMatch();
        }

        function undoLast() {
            if (currentMatch.ballHistory.length === 0) {
                showCustomAlert('Nothing to Undo', 'There are no balls to undo', '‚ÑπÔ∏è', 'info');
                return;
            }

            const lastBall = currentMatch.ballHistory.pop();
            currentMatch.commentary.pop();

            // Get the state before this ball
            const previousBall = currentMatch.ballHistory[currentMatch.ballHistory.length - 1];

            // Restore complete state
            if (lastBall.type === 'runs') {
                currentMatch.score -= lastBall.runs;
                currentMatch.balls--;
                
                // Restore batsmen from saved state
                if (lastBall.striker) {
                    currentMatch.striker = {...lastBall.striker};
                    currentMatch.striker.runs -= lastBall.runs;
                    currentMatch.striker.balls--;
                }
                if (lastBall.nonStriker) {
                    currentMatch.nonStriker = {...lastBall.nonStriker};
                }
                
                if (lastBall.bowler) {
                    currentMatch.bowler = {...lastBall.bowler};
                    currentMatch.bowler.runs -= lastBall.runs;
                    currentMatch.bowler.balls--;
                }

                // If strike was changed, swap back
                if (lastBall.runs % 2 === 1) {
                    swapBatsmen();
                }
                
            } else if (lastBall.type === 'wicket') {
                currentMatch.wickets--;
                currentMatch.balls--;
                
                // Restore the batsman who got out
                if (lastBall.striker) {
                    currentMatch.striker = {...lastBall.striker};
                    currentMatch.striker.balls--;
                }
                if (lastBall.nonStriker) {
                    currentMatch.nonStriker = {...lastBall.nonStriker};
                }
                
                if (lastBall.bowler) {
                    currentMatch.bowler = {...lastBall.bowler};
                    currentMatch.bowler.balls--;
                    currentMatch.bowler.wickets--;
                }
                
            } else if (lastBall.type === 'extra') {
                currentMatch.score -= lastBall.runs;
                
                if (lastBall.isLegalDelivery) {
                    // Byes and Leg Byes - legal deliveries
                    currentMatch.balls--;
                    
                    if (lastBall.striker) {
                        currentMatch.striker = {...lastBall.striker};
                        currentMatch.striker.balls--;
                    }
                    if (lastBall.nonStriker) {
                        currentMatch.nonStriker = {...lastBall.nonStriker};
                    }
                    
                    if (lastBall.bowler) {
                        currentMatch.bowler = {...lastBall.bowler};
                        currentMatch.bowler.balls--;
                    }

                    // If strike was changed, swap back
                    if (lastBall.runs % 2 === 1) {
                        swapBatsmen();
                    }
                } else {
                    // Wides and No Balls - not legal deliveries
                    if (lastBall.bowler) {
                        currentMatch.bowler = {...lastBall.bowler};
                        currentMatch.bowler.runs -= lastBall.runs;
                    }
                    // For no balls with runs off bat, restore striker's runs
                    if (lastBall.extraType === 'noball' && lastBall.additionalRuns > 0 && lastBall.striker) {
                        currentMatch.striker = {...lastBall.striker};
                        currentMatch.striker.runs -= lastBall.additionalRuns;
                    }
                }
            } else if (lastBall.type === 'retired') {
                // Restore the retired batsman
                if (lastBall.batsman) {
                    // Check which position was empty and restore there
                    if (!currentMatch.striker) {
                        currentMatch.striker = {...lastBall.batsman};
                    } else if (!currentMatch.nonStriker) {
                        currentMatch.nonStriker = {...lastBall.batsman};
                    }
                }
            }

            saveCurrentMatch();
            displayLiveMatch();
        }

        function swapBatsmen() {
            const temp = currentMatch.striker;
            currentMatch.striker = currentMatch.nonStriker;
            currentMatch.nonStriker = temp;
        }

        function swapStrike() {
            if (!currentMatch.striker || !currentMatch.nonStriker) {
                showCustomAlert('Cannot Swap', 'You need two batsmen on the field to swap strike', '‚ö†Ô∏è', 'warning');
                return;
            }
            
            swapBatsmen();
            saveCurrentMatch();
            displayLiveMatch();
        }

        function setStrikePreference(preference) {
            strikePreference = preference;
            
            // Update button styles
            const strikeBtn = document.getElementById('strikeBtn');
            const nonStrikeBtn = document.getElementById('nonStrikeBtn');
            
            if (preference === 'strike') {
                strikeBtn.className = 'btn btn-primary';
                nonStrikeBtn.className = 'btn btn-secondary';
            } else {
                strikeBtn.className = 'btn btn-secondary';
                nonStrikeBtn.className = 'btn btn-primary';
            }
        }

        function checkOverComplete() {
            if (currentMatch.balls % 6 === 0 && currentMatch.balls > 0) {
                const overNumber = Math.floor(currentMatch.balls / 6);
                
                // Calculate runs scored in this over
                const overStartBall = (overNumber - 1) * 6;
                let runsInOver = 0;
                let wicketsInOver = 0;
                let ballsInOverList = [];
                
                // Get last 6 balls from ball history
                const lastSixBalls = currentMatch.ballHistory.slice(-6);
                lastSixBalls.forEach(ball => {
                    if (ball.type === 'runs') {
                        runsInOver += ball.runs;
                        ballsInOverList.push(ball.runs.toString());
                    } else if (ball.type === 'wicket') {
                        wicketsInOver++;
                        ballsInOverList.push('W');
                    } else if (ball.type === 'extra') {
                        if (ball.extraType === 'wide') {
                            runsInOver += ball.runs;
                            ballsInOverList.push('Wd');
                        } else if (ball.extraType === 'noball') {
                            runsInOver += ball.runs;
                            ballsInOverList.push('Nb');
                        } else {
                            runsInOver += ball.runs;
                            if (ball.extraType === 'bye') ballsInOverList.push(`${ball.runs}b`);
                            if (ball.extraType === 'legbye') ballsInOverList.push(`${ball.runs}lb`);
                        }
                    }
                });
                
                const bowlerName = lastSixBalls.length > 0 && lastSixBalls[0].bowler ? 
                                   lastSixBalls[0].bowler.name : 'Bowler';
                
                // Add end of over summary
                currentMatch.commentary.push({
                    over: `Over ${overNumber}`,
                    text: `End of Over ${overNumber} (${bowlerName}): ${runsInOver} runs | ${ballsInOverList.join(' ')} | Score: ${currentMatch.score}/${currentMatch.wickets}`,
                    type: 'summary'
                });
                
                currentMatch.commentary.push({
                    over: 'Over',
                    text: `Batsmen have changed ends. Select new bowler to continue.`,
                    type: 'info'
                });
                
                // End of over - batsmen change ends (swap strike)
                swapBatsmen();
                
                // Bowler must be changed
                currentMatch.bowler = null;
                
                // Check if innings is complete
                if (currentMatch.balls >= currentMatch.totalOvers * 6) {
                    saveCurrentMatch();
                    endInnings();
                    return;
                }
            }
        }

        function endInnings() {
            if (currentMatch.innings === 1) {
                currentMatch.innings1Score = {
                    score: currentMatch.score,
                    wickets: currentMatch.wickets,
                    overs: currentMatch.balls / 6
                };

                const target = currentMatch.innings1Score.score + 1;

                currentMatch.commentary.push({
                    over: 'Innings',
                    text: `End of Innings 1. ${currentMatch.batting}: ${currentMatch.innings1Score.score}/${currentMatch.innings1Score.wickets} in ${currentMatch.innings1Score.overs.toFixed(1)} overs. Target for ${currentMatch.bowling}: ${target} runs`
                });

                // Swap batting and bowling teams
                const tempBatting = currentMatch.batting;
                currentMatch.batting = currentMatch.bowling;
                currentMatch.bowling = tempBatting;

                currentMatch.innings = 2;
                currentMatch.score = 0;
                currentMatch.wickets = 0;
                currentMatch.balls = 0;
                currentMatch.striker = null;
                currentMatch.nonStriker = null;
                currentMatch.bowler = null;
                
                dismissedBatsmen = []; // Reset for new innings

                saveCurrentMatch();
                displayLiveMatch();
                
                // Show custom styled innings complete modal
                showInningsCompleteModal(
                    currentMatch.bowling, 
                    currentMatch.innings1Score, 
                    currentMatch.batting, 
                    target
                );
            } else {
                showCustomConfirm(
                    'End Match?',
                    'Are you sure you want to end the 2nd innings and complete the match?',
                    'üèÅ',
                    () => endMatch(),
                    () => {}
                );
            }
        }

        async function endMatch() {
            currentMatch.innings2Score = {
                score: currentMatch.score,
                wickets: currentMatch.wickets,
                overs: currentMatch.balls / 6
            };

            currentMatch.completed = true;
            
            // Determine match result (ICC standard)
            let resultText = '';
            if (currentMatch.innings2Score.score > currentMatch.innings1Score.score) {
                const wicketsRemaining = 10 - currentMatch.innings2Score.wickets;
                resultText = `${currentMatch.team2} won by ${wicketsRemaining} wicket${wicketsRemaining !== 1 ? 's' : ''}`;
            } else if (currentMatch.innings1Score.score > currentMatch.innings2Score.score) {
                const runsMargin = currentMatch.innings1Score.score - currentMatch.innings2Score.score;
                resultText = `${currentMatch.team1} won by ${runsMargin} run${runsMargin !== 1 ? 's' : ''}`;
            } else {
                resultText = 'Match Tied';
            }
            
            currentMatch.result = resultText;
            
            // Update player statistics
            updatePlayerStats(currentMatch);
            
            matchHistory.unshift({...currentMatch});
            await saveMatchHistory();

            try {
                await window.storage.delete('currentMatch', false);
            } catch (error) {
                console.log('No current match to delete');
            }

            currentMatch = null;
            
            // Show beautiful match complete modal
            showMatchCompleteModal(resultText);
            
            setTimeout(() => {
                document.getElementById('historyTab').click();
            }, 500);
        }

        function showMatchCompleteModal(resultText) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'matchCompleteModal';
            
            // Determine trophy/icon based on result
            let icon = 'üèÜ';
            let bgGradient = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            
            if (resultText.includes('Tied')) {
                icon = 'ü§ù';
                bgGradient = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div style="text-align: center; padding: 30px;">
                        <div style="font-size: 5em; margin-bottom: 20px; animation: bounce 1s ease infinite;">${icon}</div>
                        <h2 style="color: #333; font-size: 2em; margin-bottom: 20px;">Match Completed!</h2>
                        
                        <div style="background: ${bgGradient}; color: white; padding: 25px; border-radius: 15px; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                            <div style="font-size: 1.8em; font-weight: bold; margin-bottom: 10px;">${resultText}</div>
                        </div>
                        
                        <p style="color: #666; margin: 20px 0;">View full scorecard in Match History</p>
                        
                        <button class="btn btn-primary" onclick="closeMatchCompleteModal()" style="width: 100%; padding: 15px; font-size: 1.1em; margin-top: 10px;">
                            View Match History üìä
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeMatchCompleteModal() {
            const modal = document.getElementById('matchCompleteModal');
            if (modal) modal.remove();
        }

        function updatePlayerStats(match) {
            // Track detailed batting and bowling stats for each player in the match
            
            // Process all balls to extract player performances
            const playerPerformances = {};
            
            match.ballHistory.forEach(ball => {
                if (ball.striker) {
                    const key = `${ball.striker.name}`;
                    if (!playerPerformances[key]) {
                        playerPerformances[key] = {
                            name: ball.striker.name,
                            batting: { innings: 0, runs: 0, balls: 0, fours: 0, sixes: 0, notOut: true },
                            bowling: { innings: 0, overs: 0, balls: 0, runs: 0, wickets: 0, maidens: 0 }
                        };
                    }
                }
                
                if (ball.bowler) {
                    const key = `${ball.bowler.name}`;
                    if (!playerPerformances[key]) {
                        playerPerformances[key] = {
                            name: ball.bowler.name,
                            batting: { innings: 0, runs: 0, balls: 0, fours: 0, sixes: 0, notOut: true },
                            bowling: { innings: 0, overs: 0, balls: 0, runs: 0, wickets: 0, maidens: 0 }
                        };
                    }
                }
                
                // Track batting stats
                if (ball.type === 'runs' && ball.striker) {
                    const key = `${ball.striker.name}`;
                    if (ball.runs === 4) playerPerformances[key].batting.fours++;
                    if (ball.runs === 6) playerPerformances[key].batting.sixes++;
                }
                
                // Track wickets
                if (ball.type === 'wicket' && ball.striker) {
                    const key = `${ball.striker.name}`;
                    playerPerformances[key].batting.notOut = false;
                }
            });
            
            // Get final batting scores from striker and non-striker
            if (match.striker) {
                const key = `${match.striker.name}`;
                if (playerPerformances[key]) {
                    playerPerformances[key].batting.runs = match.striker.runs;
                    playerPerformances[key].batting.balls = match.striker.balls;
                    playerPerformances[key].batting.innings = 1;
                }
            }
            
            if (match.nonStriker) {
                const key = `${match.nonStriker.name}`;
                if (playerPerformances[key]) {
                    playerPerformances[key].batting.runs = match.nonStriker.runs;
                    playerPerformances[key].batting.balls = match.nonStriker.balls;
                    playerPerformances[key].batting.innings = 1;
                }
            }
            
            // Get bowling figures from final bowler
            if (match.bowler) {
                const key = `${match.bowler.name}`;
                if (playerPerformances[key]) {
                    playerPerformances[key].bowling.runs = match.bowler.runs;
                    playerPerformances[key].bowling.balls = match.bowler.balls;
                    playerPerformances[key].bowling.wickets = match.bowler.wickets;
                    playerPerformances[key].bowling.overs = Math.floor(match.bowler.balls / 6);
                    playerPerformances[key].bowling.innings = 1;
                }
            }
            
            // Update career statistics for each player
            Object.values(playerPerformances).forEach(perf => {
                // Find player's team
                const player = players.find(p => p.name === perf.name);
                if (!player) return;
                
                const playerKey = `${player.team}:${perf.name}`;
                
                if (!playerStats[playerKey]) {
                    playerStats[playerKey] = {
                        matchesPlayed: 0,
                        batting: {
                            innings: 0,
                            runs: 0,
                            balls: 0,
                            highScore: 0,
                            notOuts: 0,
                            fours: 0,
                            sixes: 0,
                            fifties: 0,
                            hundreds: 0
                        },
                        bowling: {
                            innings: 0,
                            balls: 0,
                            runs: 0,
                            wickets: 0,
                            bestBowling: { wickets: 0, runs: 999 }
                        }
                    };
                }
                
                const stats = playerStats[playerKey];
                stats.matchesPlayed++;
                
                // Update batting stats
                if (perf.batting.innings > 0) {
                    stats.batting.innings++;
                    stats.batting.runs += perf.batting.runs;
                    stats.batting.balls += perf.batting.balls;
                    stats.batting.fours += perf.batting.fours;
                    stats.batting.sixes += perf.batting.sixes;
                    
                    if (perf.batting.notOut) {
                        stats.batting.notOuts++;
                    }
                    
                    if (perf.batting.runs > stats.batting.highScore) {
                        stats.batting.highScore = perf.batting.runs;
                    }
                    
                    if (perf.batting.runs >= 50 && perf.batting.runs < 100) {
                        stats.batting.fifties++;
                    }
                    
                    if (perf.batting.runs >= 100) {
                        stats.batting.hundreds++;
                    }
                }
                
                // Update bowling stats
                if (perf.bowling.innings > 0) {
                    stats.bowling.innings++;
                    stats.bowling.balls += perf.bowling.balls;
                    stats.bowling.runs += perf.bowling.runs;
                    stats.bowling.wickets += perf.bowling.wickets;
                    
                    // Update best bowling figures
                    if (perf.bowling.wickets > stats.bowling.bestBowling.wickets ||
                        (perf.bowling.wickets === stats.bowling.bestBowling.wickets && 
                         perf.bowling.runs < stats.bowling.bestBowling.runs)) {
                        stats.bowling.bestBowling = {
                            wickets: perf.bowling.wickets,
                            runs: perf.bowling.runs
                        };
                    }
                }
            });

            savePlayerStats();
        }

        async function addPlayerToRoster() {
            const nameInput = document.getElementById('newPlayerName');
            const teamSelect = document.getElementById('newPlayerTeam');
            const profilePicInput = document.getElementById('playerProfilePic');
            const name = nameInput.value.trim();
            const team = teamSelect.value;
            
            if (!name) {
                showCustomAlert('Name Required', 'Please enter a player name', '‚úèÔ∏è', 'warning');
                return;
            }

            if (!team) {
                showCustomAlert('Team Required', 'Please select a team for this player', 'üèè', 'warning');
                return;
            }

            // Check if player with same name and team already exists
            const existingPlayer = players.find(p => p.name === name && p.team === team);
            if (existingPlayer) {
                showCustomAlert('Duplicate Player', `${name} already exists in ${team}`, '‚ö†Ô∏è', 'warning');
                return;
            }

            // Handle profile picture
            let profilePicBase64 = null;
            if (profilePicInput.files && profilePicInput.files[0]) {
                const file = profilePicInput.files[0];
                
                // Check file size (max 500KB)
                if (file.size > 500 * 1024) {
                    showCustomAlert('Image Too Large', 'Image size should be less than 500KB. Please choose a smaller image.', 'üì∏', 'warning');
                    return;
                }
                
                // Convert to base64
                try {
                    profilePicBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                } catch (error) {
                    console.error('Error reading image:', error);
                    showCustomAlert('Upload Error', 'Error uploading image. Please try again.', '‚ùå', 'warning');
                    return;
                }
            }

            const playerObj = { name, team, profilePic: profilePicBase64 };
            players.push(playerObj);
            
            // Initialize stats for new player (keyed by team:name for uniqueness)
            const playerKey = `${team}:${name}`;
            if (!playerStats[playerKey]) {
                playerStats[playerKey] = {
                    matchesPlayed: 0,
                    batting: {
                        innings: 0,
                        runs: 0,
                        balls: 0,
                        highScore: 0,
                        notOuts: 0,
                        fours: 0,
                        sixes: 0,
                        fifties: 0,
                        hundreds: 0
                    },
                    bowling: {
                        innings: 0,
                        balls: 0,
                        runs: 0,
                        wickets: 0,
                        bestBowling: { wickets: 0, runs: 999 }
                    }
                };
            }

            await savePlayers();
            await savePlayerStats();
            
            nameInput.value = '';
            teamSelect.value = '';
            profilePicInput.value = '';
            displayPlayerRoster();
        }

        async function removePlayerFromRoster(playerName, playerTeam) {
            if (!confirm(`Remove ${playerName} (${playerTeam}) from roster?`)) return;

            const index = players.findIndex(p => p.name === playerName && p.team === playerTeam);
            if (index > -1) {
                players.splice(index, 1);
                await savePlayers();
                displayPlayerRoster();
            }
        }

        function displayPlayerRoster() {
            const rosterDiv = document.getElementById('playerRoster');
            
            if (players.length === 0) {
                rosterDiv.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 4em; margin-bottom: 20px;">üë•</div>
                        <h2>No Players Added</h2>
                        <p>Add players to your roster to get started</p>
                    </div>
                `;
                return;
            }

            rosterDiv.innerHTML = '';
            
            // Group players by team
            const playersByTeam = {};
            players.forEach(player => {
                if (!playersByTeam[player.team]) {
                    playersByTeam[player.team] = [];
                }
                playersByTeam[player.team].push(player);
            });

            // Sort teams alphabetically
            const sortedTeams = Object.keys(playersByTeam).sort();
            
            sortedTeams.forEach(team => {
                rosterDiv.innerHTML += `
                    <h4 style="margin: 20px 0 10px 0; color: #667eea; font-size: 1.2em;">${team}</h4>
                `;
                
                // Sort players within team
                const teamPlayers = playersByTeam[team].sort((a, b) => a.name.localeCompare(b.name));
                
                teamPlayers.forEach(player => {
                    const playerKey = `${player.team}:${player.name}`;
                    const stats = playerStats[playerKey] || {
                        matchesPlayed: 0,
                        batting: { innings: 0, runs: 0, balls: 0, highScore: 0, notOuts: 0, fours: 0, sixes: 0, fifties: 0, hundreds: 0 },
                        bowling: { innings: 0, balls: 0, runs: 0, wickets: 0, bestBowling: { wickets: 0, runs: 0 } }
                    };
                    
                    // Calculate batting average
                    const dismissals = stats.batting.innings - stats.batting.notOuts;
                    const battingAvg = dismissals > 0 ? (stats.batting.runs / dismissals).toFixed(2) : 
                                      stats.batting.runs > 0 ? `${stats.batting.runs}*` : '0.00';
                    
                    // Calculate strike rate
                    const strikeRate = stats.batting.balls > 0 ? 
                                      ((stats.batting.runs / stats.batting.balls) * 100).toFixed(2) : '0.00';
                    
                    // Calculate bowling average and economy
                    const bowlingAvg = stats.bowling.wickets > 0 ? 
                                      (stats.bowling.runs / stats.bowling.wickets).toFixed(2) : '-';
                    const economy = stats.bowling.balls > 0 ? 
                                   ((stats.bowling.runs / (stats.bowling.balls / 6))).toFixed(2) : '0.00';
                    
                    // Get initials for placeholder
                    const initials = player.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                    
                    const avatarHTML = player.profilePic ? 
                        `<img src="${player.profilePic}" class="player-avatar" alt="${player.name}">` :
                        `<div class="player-avatar-placeholder">${initials}</div>`;
                    
                    rosterDiv.innerHTML += `
                        <div class="player-roster-card">
                            ${avatarHTML}
                            <div class="player-roster-info" style="flex: 1;">
                                <div class="player-roster-name">${player.name}</div>
                                <div class="player-roster-stats">
                                    <span style="font-weight: 600; color: #667eea;">Matches: ${stats.matchesPlayed}</span>
                                </div>
                                ${stats.batting.innings > 0 ? `
                                    <div class="player-roster-stats" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6;">
                                        <span style="font-weight: 600; color: #333;">Batting:</span>
                                        <span>Runs: ${stats.batting.runs}</span>
                                        <span>Avg: ${battingAvg}</span>
                                        <span>SR: ${strikeRate}</span>
                                        <span>HS: ${stats.batting.highScore}${stats.batting.highScore > 0 && stats.batting.notOuts > 0 ? '*' : ''}</span>
                                    </div>
                                    <div class="player-roster-stats">
                                        <span>4s: ${stats.batting.fours}</span>
                                        <span>6s: ${stats.batting.sixes}</span>
                                        ${stats.batting.fifties > 0 ? `<span>50s: ${stats.batting.fifties}</span>` : ''}
                                        ${stats.batting.hundreds > 0 ? `<span>100s: ${stats.batting.hundreds}</span>` : ''}
                                    </div>
                                ` : ''}
                                ${stats.bowling.innings > 0 ? `
                                    <div class="player-roster-stats" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6;">
                                        <span style="font-weight: 600; color: #333;">Bowling:</span>
                                        <span>Wkts: ${stats.bowling.wickets}</span>
                                        <span>Avg: ${bowlingAvg}</span>
                                        <span>Econ: ${economy}</span>
                                        <span>Best: ${bestBowling}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="player-roster-actions">
                                <button class="btn btn-danger" onclick="removePlayerFromRoster('${player.name}', '${player.team}')">Remove</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        function openPlayerModal(type) {
            currentPlayerType = type;
            const teamName = type === 'batsman' ? currentMatch.batting : currentMatch.bowling;
            const modalType = type === 'batsman' ? 'Batsman' : 'Bowler';
            document.getElementById('modalTitle').textContent = `Select ${modalType} (${teamName})`;
            
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';

            // Show strike selection for batsmen only
            const strikeSelection = document.getElementById('strikeSelection');
            if (type === 'batsman' && (currentMatch.striker || currentMatch.nonStriker)) {
                strikeSelection.style.display = 'block';
                // Set default based on who's missing
                if (!currentMatch.striker) {
                    setStrikePreference('strike');
                } else if (!currentMatch.nonStriker) {
                    setStrikePreference('nonstrike');
                }
            } else {
                strikeSelection.style.display = 'none';
            }

            // Filter players by team
            const teamToFilter = type === 'batsman' ? currentMatch.batting : currentMatch.bowling;
            const teamPlayers = players.filter(p => p.team === teamToFilter);

            if (teamPlayers.length === 0) {
                playerList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>No players added for ${teamToFilter}</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">Add players in the Players tab or add a new player below</p>
                    </div>
                `;
            }

            teamPlayers.forEach(player => {
                const isSelected = type === 'batsman' ? 
                    (currentMatch.striker?.name === player.name || currentMatch.nonStriker?.name === player.name) :
                    (currentMatch.bowler?.name === player.name);
                
                const isOut = type === 'batsman' && dismissedBatsmen.includes(player.name);
                
                if (!isSelected || type !== 'batsman') {
                    const disabled = isOut ? 'disabled' : '';
                    const btnClass = isOut ? 'btn btn-secondary' : 'btn btn-primary';
                    const btnText = isOut ? 'OUT' : 'Select';
                    const opacity = isOut ? 'opacity: 0.5;' : '';
                    
                    playerList.innerHTML += `
                        <div class="player-item" style="${opacity}">
                            <span>${player.name}${isOut ? ' (Already Out)' : ''}</span>
                            <button class="${btnClass}" onclick="selectPlayer('${player.name}')" ${disabled}>${btnText}</button>
                        </div>
                    `;
                }
            });

            document.getElementById('playerModal').classList.add('active');
        }

        function closePlayerModal() {
            document.getElementById('playerModal').classList.remove('active');
            document.getElementById('playerNameInput').value = '';
        }

        async function addNewPlayer() {
            const name = document.getElementById('playerNameInput').value.trim();
            if (!name) {
                showCustomAlert('Name Required', 'Please enter a player name', '‚úèÔ∏è', 'warning');
                return;
            }

            // Determine which team to add to based on current player type
            const team = currentPlayerType === 'batsman' ? currentMatch.batting : currentMatch.bowling;

            // Check if player already exists for this team
            const existingPlayer = players.find(p => p.name === name && p.team === team);
            if (!existingPlayer) {
                const playerObj = { name, team, profilePic: null };
                players.push(playerObj);
                
                const playerKey = `${team}:${name}`;
                if (!playerStats[playerKey]) {
                    playerStats[playerKey] = {
                        matchesPlayed: 0,
                        batting: {
                            innings: 0,
                            runs: 0,
                            balls: 0,
                            highScore: 0,
                            notOuts: 0,
                            fours: 0,
                            sixes: 0,
                            fifties: 0,
                            hundreds: 0
                        },
                        bowling: {
                            innings: 0,
                            balls: 0,
                            runs: 0,
                            wickets: 0,
                            bestBowling: { wickets: 0, runs: 999 }
                        }
                    };
                }
                
                await savePlayers();
                await savePlayerStats();
            }

            selectPlayer(name);
            closePlayerModal();
        }

        function selectPlayer(playerName) {
            if (currentPlayerType === 'batsman') {
                const newBatsman = {
                    name: playerName,
                    runs: 0,
                    balls: 0
                };

                if (!currentMatch.striker && !currentMatch.nonStriker) {
                    // First batsman - always goes on strike
                    currentMatch.striker = newBatsman;
                } else if (!currentMatch.striker) {
                    // No striker - new batsman goes on strike
                    currentMatch.striker = newBatsman;
                } else if (!currentMatch.nonStriker) {
                    // No non-striker - new batsman goes to non-strike
                    currentMatch.nonStriker = newBatsman;
                } else {
                    // Both positions filled - replace based on preference
                    if (strikePreference === 'strike') {
                        currentMatch.striker = newBatsman;
                    } else {
                        currentMatch.nonStriker = newBatsman;
                    }
                }
            } else {
                currentMatch.bowler = {
                    name: playerName,
                    runs: 0,
                    balls: 0,
                    wickets: 0
                };
            }

            saveCurrentMatch();
            displayLiveMatch();
            closePlayerModal();
        }

        async function displayMatchHistory() {
            try {
                const historyData = await window.storage.get('matchHistory', true);
                if (historyData) {
                    matchHistory = JSON.parse(historyData.value);
                }
            } catch (error) {
                console.log('No match history found');
            }

            const historyDiv = document.getElementById('matchHistory');
            
            if (matchHistory.length === 0) {
                historyDiv.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 4em; margin-bottom: 20px;">üìä</div>
                        <h2>No Match History</h2>
                        <p>Completed matches will appear here</p>
                    </div>
                `;
                return;
            }

            historyDiv.innerHTML = '';
            matchHistory.forEach(match => {
                const score1 = match.innings1Score ? 
                    `${match.innings1Score.score}/${match.innings1Score.wickets}` : 'N/A';
                const score2 = match.innings2Score ? 
                    `${match.innings2Score.score}/${match.innings2Score.wickets}` : 'N/A';

                historyDiv.innerHTML += `
                    <div class="match-card" onclick="viewMatchDetails(${match.id})">
                        <div class="match-header">
                            <div class="match-teams">${match.team1} vs ${match.team2}</div>
                            <div class="match-date">${match.date}</div>
                        </div>
                        <div class="match-score">
                            ${match.team1}: ${score1} | ${match.team2}: ${score2}
                        </div>
                    </div>
                `;
            });
        }

        function viewMatchDetails(matchId) {
            const match = matchHistory.find(m => m.id === matchId);
            if (!match) return;

            // Build tabbed interface
            document.getElementById('matchDetails').innerHTML = `
                <div style="display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px;">
                    <button onclick="showMatchDetailTab('summary')" id="summaryMatchTab" style="flex: 1; padding: 12px; border: none; background: white; font-weight: 600; border-bottom: 3px solid #667eea; color: #667eea; cursor: pointer;">Summary</button>
                    <button onclick="showMatchDetailTab('scorecard')" id="scorecardMatchTab" style="flex: 1; padding: 12px; border: none; background: #f8f9fa; font-weight: 600; color: #666; cursor: pointer;">Scorecard</button>
                </div>
                
                <div id="summaryMatchContent"></div>
                <div id="scorecardMatchContent" style="display: none;"></div>
            `;

            // Render both views
            renderMatchSummary(match);
            renderMatchScorecard(match);

            document.getElementById('matchModal').classList.add('active');
        }

        function showMatchDetailTab(tab) {
            const summaryBtn = document.getElementById('summaryMatchTab');
            const scorecardBtn = document.getElementById('scorecardMatchTab');
            const summaryContent = document.getElementById('summaryMatchContent');
            const scorecardContent = document.getElementById('scorecardMatchContent');

            if (tab === 'summary') {
                summaryBtn.style.background = 'white';
                summaryBtn.style.borderBottom = '3px solid #667eea';
                summaryBtn.style.color = '#667eea';
                scorecardBtn.style.background = '#f8f9fa';
                scorecardBtn.style.borderBottom = 'none';
                scorecardBtn.style.color = '#666';
                summaryContent.style.display = 'block';
                scorecardContent.style.display = 'none';
            } else {
                scorecardBtn.style.background = 'white';
                scorecardBtn.style.borderBottom = '3px solid #667eea';
                scorecardBtn.style.color = '#667eea';
                summaryBtn.style.background = '#f8f9fa';
                summaryBtn.style.borderBottom = 'none';
                summaryBtn.style.color = '#666';
                summaryContent.style.display = 'none';
                scorecardContent.style.display = 'block';
            }
        }

        function renderMatchSummary(match) {
            const score1 = match.innings1Score ? 
                `${match.innings1Score.score}/${match.innings1Score.wickets} (${match.innings1Score.overs.toFixed(1)})` : 'N/A';
            const score2 = match.innings2Score ? 
                `${match.innings2Score.score}/${match.innings2Score.wickets} (${match.innings2Score.overs.toFixed(1)})` : 'N/A';

            let result = match.result || '';
            if (!result && match.innings1Score && match.innings2Score) {
                if (match.innings2Score.score > match.innings1Score.score) {
                    result = `${match.team2} won by ${10 - match.innings2Score.wickets} wickets`;
                } else if (match.innings1Score.score > match.innings2Score.score) {
                    result = `${match.team1} won by ${match.innings1Score.score - match.innings2Score.score} runs`;
                } else {
                    result = 'Match Tied';
                }
            }

            // Find heroes
            const performances = extractMatchPerformances(match);
            const bestBatter = performances.batsmen[0];
            const bestBowler = performances.bowlers[0];

            document.getElementById('summaryMatchContent').innerHTML = `
                <h3 style="margin-bottom: 5px;">${match.team1} vs ${match.team2}</h3>
                <p style="color: #666; font-size: 0.9em;">${match.date} ‚Ä¢ ${match.totalOvers} overs</p>
                
                <div style="margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="color: #666;">${match.team1}</span>
                        <span style="font-size: 1.5em; font-weight: bold;">${score1}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #666;">${match.team2}</span>
                        <span style="font-size: 1.5em; font-weight: bold;">${score2}</span>
                    </div>
                </div>

                ${result ? `<div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 12px 20px; border-radius: 10px; text-align: center; font-weight: 600; color: white; margin-bottom: 20px;">${result}</div>` : ''}
                
                <h3 style="margin: 25px 0 15px 0;">Heroes of the Match</h3>
                
                ${bestBatter ? `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 18px; margin-bottom: 12px; color: white;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.25); display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;">${bestBatter.name.substring(0,2)}</div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.8em; opacity: 0.9;">Player of the Match</div>
                            <div style="font-size: 1.3em; font-weight: bold; margin: 3px 0;">${bestBatter.name}</div>
                            <div style="font-size: 0.9em;">${bestBatter.runs}* (${bestBatter.balls})</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.6em; font-weight: bold;">${((bestBatter.runs / bestBatter.balls) * 10).toFixed(1)}</div>
                            <div style="font-size: 0.75em; opacity: 0.9;">MVP</div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    ${bestBatter ? `
                    <div style="background: #f8f9fa; border-radius: 10px; padding: 15px;">
                        <div style="font-size: 0.8em; color: #666; margin-bottom: 8px;">Best Batter</div>
                        <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-bottom: 8px; font-size: 1.2em;">${bestBatter.name.substring(0,2)}</div>
                        <div style="font-weight: 600; margin-bottom: 3px;">${bestBatter.name}</div>
                        <div style="font-size: 1.2em; font-weight: bold; color: #667eea;">${bestBatter.runs}*</div>
                        <div style="font-size: 0.85em; color: #666;">(${bestBatter.balls}) ${bestBatter.fours}√ó4 ${bestBatter.sixes}√ó6</div>
                    </div>
                    ` : ''}
                    
                    ${bestBowler ? `
                    <div style="background: #f8f9fa; border-radius: 10px; padding: 15px;">
                        <div style="font-size: 0.8em; color: #666; margin-bottom: 8px;">Best Bowler</div>
                        <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #f093fb, #f5576c); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-bottom: 8px; font-size: 1.2em;">${bestBowler.name.substring(0,2)}</div>
                        <div style="font-weight: 600; margin-bottom: 3px;">${bestBowler.name}</div>
                        <div style="font-size: 1.2em; font-weight: bold; color: #f5576c;">${bestBowler.wickets}/${bestBowler.runs}</div>
                        <div style="font-size: 0.85em; color: #666;">(${Math.floor(bestBowler.balls/6)}.${bestBowler.balls%6})</div>
                    </div>
                    ` : `
                    <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; text-align: center;">
                        <div style="font-size: 0.8em; color: #666; margin-bottom: 8px;">Best Bowler</div>
                        <div style="color: #999; padding: 20px 0;">No bowlers</div>
                    </div>
                    `}
                </div>
                
                ${performances.batsmen.length > 2 ? `
                <h3 style="margin: 20px 0 12px 0;">Star Performances</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    ${performances.batsmen.slice(1, 5).map(p => `
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 10px;">
                            <div style="font-weight: 600; font-size: 0.95em;">${p.name}</div>
                            <div style="color: #667eea; font-weight: 600; font-size: 0.9em;">${p.runs}* (${p.balls})</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            `;
        }

        function renderMatchScorecard(match) {
            const score1 = match.innings1Score ? 
                `${match.innings1Score.score}/${match.innings1Score.wickets} (${match.innings1Score.overs.toFixed(1)} overs)` : 'N/A';
            const score2 = match.innings2Score ? 
                `${match.innings2Score.score}/${match.innings2Score.wickets} (${match.innings2Score.overs.toFixed(1)} overs)` : 'N/A';

            // Extract performances per innings
            const innings1Data = extractInningsPerformances(match, 1);
            const innings2Data = extractInningsPerformances(match, 2);

            let html = `
                <h3 style="margin-bottom: 20px; color: #333;">Innings 1 - ${match.team1}</h3>
                <p style="font-weight: bold; color: #667eea; font-size: 1.3em; margin: 10px 0;">${score1}</p>
                
                ${innings1Data.batsmen.length > 0 ? `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h5 style="margin: 0 0 10px 0;">Batsmen</h5>
                    ${innings1Data.batsmen.map(p => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                            <span style="font-weight: 600;">${p.name}</span>
                            <span>${p.runs}${p.notOut ? '*' : ''} (${p.balls}) SR: ${p.sr}</span>
                        </div>
                    `).join('')}
                </div>
                ` : '<p style="color: #999; padding: 20px 0;">No batting data</p>'}
                
                ${innings1Data.bowlers.length > 0 ? `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h5 style="margin: 0 0 10px 0;">Bowlers</h5>
                    ${innings1Data.bowlers.map(p => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                            <span style="font-weight: 600;">${p.name}</span>
                            <span>${p.wickets}/${p.runs} (${Math.floor(p.balls/6)}.${p.balls%6}) Eco: ${p.economy}</span>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            `;

            // Only show innings 2 if it exists
            if (match.innings2Score) {
                html += `
                    <h3 style="margin: 30px 0 20px 0; color: #333; padding-top: 20px; border-top: 2px solid #e0e0e0;">Innings 2 - ${match.team2}</h3>
                    <p style="font-weight: bold; color: #667eea; font-size: 1.3em; margin: 10px 0;">${score2}</p>
                    
                    ${innings2Data.batsmen.length > 0 ? `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <h5 style="margin: 0 0 10px 0;">Batsmen</h5>
                        ${innings2Data.batsmen.map(p => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                                <span style="font-weight: 600;">${p.name}</span>
                                <span>${p.runs}${p.notOut ? '*' : ''} (${p.balls}) SR: ${p.sr}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : '<p style="color: #999; padding: 20px 0;">No batting data</p>'}
                    
                    ${innings2Data.bowlers.length > 0 ? `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <h5 style="margin: 0 0 10px 0;">Bowlers</h5>
                        ${innings2Data.bowlers.map(p => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                                <span style="font-weight: 600;">${p.name}</span>
                                <span>${p.wickets}/${p.runs} (${Math.floor(p.balls/6)}.${p.balls%6}) Eco: ${p.economy}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                `;
            }

            document.getElementById('scorecardMatchContent').innerHTML = html;
        }

        function extractInningsPerformances(match, inningsNum) {
            const batsmen = [];
            const bowlers = [];
            
            if (!match.ballHistory || match.ballHistory.length === 0) return { batsmen, bowlers };

            const playerData = {};
            
            // Find where innings changes by looking at ball counter reset
            // In innings 1, balls count up from 0
            // When innings 2 starts, balls reset back to low numbers
            let innings1EndIndex = match.ballHistory.length;
            
            if (match.innings1Score) {
                // Find where ball count drops (indicates innings change)
                for (let i = 1; i < match.ballHistory.length; i++) {
                    if (match.ballHistory[i].balls < match.ballHistory[i-1].balls) {
                        innings1EndIndex = i;
                        break;
                    }
                }
            }
            
            // Filter balls by innings
            const inningsBalls = match.ballHistory.filter((ball, index) => {
                if (inningsNum === 1) {
                    return index < innings1EndIndex;
                } else {
                    return index >= innings1EndIndex;
                }
            });
            
            // Process the balls for this innings
            inningsBalls.forEach(ball => {
                if (ball.striker && ball.striker.name) {
                    if (!playerData[ball.striker.name]) {
                        playerData[ball.striker.name] = {
                            name: ball.striker.name,
                            runs: 0, balls: 0, fours: 0, sixes: 0, notOut: true
                        };
                    }
                    if (ball.type === 'runs') {
                        if (ball.runs === 4) playerData[ball.striker.name].fours++;
                        if (ball.runs === 6) playerData[ball.striker.name].sixes++;
                    }
                    if (ball.type === 'wicket') {
                        playerData[ball.striker.name].notOut = false;
                    }
                    // Update final stats from ball data
                    playerData[ball.striker.name].runs = ball.striker.runs;
                    playerData[ball.striker.name].balls = ball.striker.balls;
                }
                
                if (ball.bowler && ball.bowler.name) {
                    if (!playerData[ball.bowler.name]) {
                        playerData[ball.bowler.name] = {
                            name: ball.bowler.name,
                            bowlingRuns: 0, balls: 0, wickets: 0
                        };
                    }
                    // Update bowling stats from ball data
                    playerData[ball.bowler.name].balls = ball.bowler.balls || 0;
                    playerData[ball.bowler.name].bowlingRuns = ball.bowler.runs || 0;
                    playerData[ball.bowler.name].wickets = ball.bowler.wickets || 0;
                }
            });

            Object.values(playerData).forEach(p => {
                if (p.runs !== undefined && p.balls > 0) {
                    batsmen.push({
                        name: p.name,
                        runs: p.runs,
                        balls: p.balls,
                        fours: p.fours || 0,
                        sixes: p.sixes || 0,
                        notOut: p.notOut !== false,
                        sr: p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(1) : '0.0'
                    });
                }
                
                if (p.wickets !== undefined && p.balls > 0) {
                    const economy = p.balls > 0 ? ((p.bowlingRuns / (p.balls / 6)).toFixed(2)) : '0.00';
                    bowlers.push({
                        name: p.name,
                        runs: p.bowlingRuns || 0,
                        balls: p.balls || 0,
                        wickets: p.wickets,
                        economy: economy
                    });
                }
            });

            batsmen.sort((a, b) => b.runs - a.runs);
            bowlers.sort((a, b) => {
                if (b.wickets !== a.wickets) return b.wickets - a.wickets;
                return a.runs - b.runs;
            });

            return { batsmen, bowlers };
        }

        function extractMatchPerformances(match) {
            const batsmen = [];
            const bowlers = [];
            
            if (!match.ballHistory) return { batsmen, bowlers };

            const playerData = {};
            
            match.ballHistory.forEach(ball => {
                if (ball.striker && ball.striker.name) {
                    if (!playerData[ball.striker.name]) {
                        playerData[ball.striker.name] = {
                            name: ball.striker.name,
                            runs: 0, balls: 0, fours: 0, sixes: 0, notOut: true
                        };
                    }
                    if (ball.type === 'runs') {
                        if (ball.runs === 4) playerData[ball.striker.name].fours++;
                        if (ball.runs === 6) playerData[ball.striker.name].sixes++;
                    }
                    if (ball.type === 'wicket') {
                        playerData[ball.striker.name].notOut = false;
                    }
                }
                
                if (ball.bowler && ball.bowler.name) {
                    if (!playerData[ball.bowler.name]) {
                        playerData[ball.bowler.name] = {
                            name: ball.bowler.name,
                            bowlingRuns: 0, balls: 0, wickets: 0
                        };
                    }
                }
            });

            if (match.striker) {
                if (playerData[match.striker.name]) {
                    playerData[match.striker.name].runs = match.striker.runs;
                    playerData[match.striker.name].balls = match.striker.balls;
                }
            }
            
            if (match.nonStriker) {
                if (playerData[match.nonStriker.name]) {
                    playerData[match.nonStriker.name].runs = match.nonStriker.runs;
                    playerData[match.nonStriker.name].balls = match.nonStriker.balls;
                }
            }
            
            if (match.bowler) {
                if (playerData[match.bowler.name]) {
                    playerData[match.bowler.name].bowlingRuns = match.bowler.runs;
                    playerData[match.bowler.name].balls = match.bowler.balls;
                    playerData[match.bowler.name].wickets = match.bowler.wickets;
                }
            }

            Object.values(playerData).forEach(p => {
                if (p.runs !== undefined && p.runs > 0) {
                    batsmen.push({
                        name: p.name,
                        runs: p.runs,
                        balls: p.balls,
                        fours: p.fours || 0,
                        sixes: p.sixes || 0,
                        notOut: p.notOut !== false,
                        sr: p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(1) : '0.0'
                    });
                }
                
                if (p.wickets !== undefined && p.balls > 0) {  // Only include if they bowled
                    bowlers.push({
                        name: p.name,
                        runs: p.bowlingRuns || 0,
                        balls: p.balls || 0,
                        wickets: p.wickets
                    });
                }
            });

            batsmen.sort((a, b) => b.runs - a.runs);
            bowlers.sort((a, b) => {
                // Sort by wickets first, then by economy rate (lower is better)
                if (b.wickets !== a.wickets) {
                    return b.wickets - a.wickets;
                }
                // If same wickets, prefer lower runs
                return a.runs - b.runs;
            });

            return { batsmen, bowlers };
        }

        function closeMatchModal() {
            document.getElementById('matchModal').classList.remove('active');
        }

        function showExtrasModal(type) {
            currentExtraType = type;
            const modal = document.getElementById('extrasModal');
            const title = document.getElementById('extrasTitle');
            const description = document.getElementById('extrasDescription');
            
            if (type === 'wide') {
                title.textContent = 'Wide Ball';
                description.textContent = 'Select additional runs scored (1 run penalty + runs scored). Select 0 for just the wide.';
            } else if (type === 'noball') {
                title.textContent = 'No Ball';
                description.textContent = 'Select runs scored off the bat (1 run penalty + runs off bat). Select 0 for just the no ball.';
            } else if (type === 'bye') {
                title.textContent = 'Byes';
                description.textContent = 'Select number of byes scored.';
            } else if (type === 'legbye') {
                title.textContent = 'Leg Byes';
                description.textContent = 'Select number of leg byes scored.';
            }
            
            modal.classList.add('active');
        }

        function closeExtrasModal() {
            document.getElementById('extrasModal').classList.remove('active');
            currentExtraType = '';
        }

        function confirmExtra(additionalRuns) {
            addExtra(currentExtraType, additionalRuns);
            closeExtrasModal();
        }

        // Initialize on load
        init();
    </script>
</body>
</html>